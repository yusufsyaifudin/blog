<!doctype html><html lang=en dir=ltr><head><meta name=generator content="Hugo 0.121.1"><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In this part, I will mainly focusing on preparing Rails application. If you already know about the Rails and want to only focusing on how to make the logs better, you can skip this part and jump to Part 2.
Prepare Rails Application # To make this tutorial is easier to follow both for experienced RoR developers and newcomers, I will create easy to follow step by step tutorial from installing Rails to adding OpenTelemetry library to customize the log output in Rails application."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID (Part 1 - Preparing Rails Application)"><meta property="og:description" content="In this part, I will mainly focusing on preparing Rails application. If you already know about the Rails and want to only focusing on how to make the logs better, you can skip this part and jump to Part 2.
Prepare Rails Application # To make this tutorial is easier to follow both for experienced RoR developers and newcomers, I will create easy to follow step by step tutorial from installing Rails to adding OpenTelemetry library to customize the log output in Rails application."><meta property="og:type" content="article"><meta property="og:url" content="https://yusufsyaifudin.github.io/blog/posts/2023-02-24-rails-otel-part1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-24T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-27T08:44:23+07:00"><title>Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID (Part 1 - Preparing Rails Application) | yusuf's blog</title>
<link rel=manifest href=/blog/manifest.json><link rel=icon href=/blog/favicon.png type=image/x-icon><link rel=stylesheet href=/blog/book.min.68be0b7a9674f2a612ce0e9b2e9447ff4b7ac96546e06b642bfd3ded0ca490ef.css integrity="sha256-aL4LepZ08qYSzg6bLpRH/0t6yWVG4GtkK/097QykkO8="><script defer src=/blog/en.search.min.6149d4acd80a18dc8f60a77b51c7975178d937cc3dd7013178f45aac2723a259.js integrity="sha256-YUnUrNgKGNyPYKd7UceXUXjZN8w91wExePRarCcjolk="></script><script defer src=/blog/sw.min.e30dcfc647efc866455c67b26b2aabda17816f06fe2dd202ac21b4422180bd9b.js integrity="sha256-4w3PxkfvyGZFXGeyayqr2heBbwb+LdICrCG0QiGAvZs="></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/blog><span>yusuf's blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/blog/posts/>Blog</a></li><li><a href=https://github.com/yusufsyaifudin target=_blank rel=noopener>My Github</a></li><li><a href=https://github.com/alex-shpak/hugo-book target=_blank rel=noopener>Hugo Theme</a></li></ul></nav><script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/blog/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID (Part 1 - Preparing Rails Application)</strong>
<label for=toc-control><img src=/blog/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#prepare-rails-application>Prepare Rails Application</a><ul><li><a href=#installing-rails>Installing Rails</a></li><li><a href=#running-rails-using-docker>Running Rails using Docker</a></li></ul></li><li><a href=#add-route-mimicking-nested-function-calls-operation>Add route mimicking nested function calls operation</a><ul><li><a href=#preparing-postgres-database-and-gem-library-to-connect>Preparing Postgres Database and Gem Library To Connect</a></li><li><a href=#creating-users-table-and-connecting-using-active-record>Creating Users Table and Connecting Using Active Record</a></li><li><a href=#creating-services-jwt-encoderdecoder-and-controller>Creating Services, JWT encoder/decoder, and Controller</a></li><li><a href=#registering-routes>Registering Routes</a></li><li><a href=#insert-user-data-and-create-jwt-access-token-via-rails-console>Insert User data and Create JWT access token via <code>rails console</code></a></li><li><a href=#accessing-the-routes>Accessing the routes</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1><a href=/blog/posts/2023-02-24-rails-otel-part1/>Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID (Part 1 - Preparing Rails Application)</a></h1><h5>February 24, 2023</h5><div><a href=/blog/categories/tutorials/>tutorials</a></div><div><a href=/blog/tags/ruby/>ruby</a>,
<a href=/blog/tags/rails/>rails</a>,
<a href=/blog/tags/opentelemetry/>opentelemetry</a></div><p>In this part, I will mainly focusing on preparing Rails application. If you already know about the Rails and want to only focusing on how to make the logs better, you can skip this part and
<a href=/posts/2023-02-24-rails-otel-part2/>jump to Part 2</a>.</p><h1 id=prepare-rails-application>Prepare Rails Application
<a class=anchor href=#prepare-rails-application>#</a></h1><p>To make this tutorial is easier to follow both for experienced RoR developers and newcomers, I will create easy to follow step by step tutorial from installing Rails to adding OpenTelemetry library to customize the log output in Rails application. I hope it also gives you (the reader) idea on how adding OpenTelemetry on your existing code.</p><blockquote><p><strong>WARNING!!!</strong></p><p>All code in this tutorial is not production ready! For example, I don&rsquo;t validate JWT token but only decode it.</p></blockquote><h2 id=installing-rails>Installing Rails
<a class=anchor href=#installing-rails>#</a></h2><p>I will not tell you to install Ruby and Rails in your host machine. I suggest you to install Docker by following this link:</p><ul><li>Install on Mac
<a href=https://docs.docker.com/desktop/install/mac-install/>https://docs.docker.com/desktop/install/mac-install/</a></li><li>Install on Windows
<a href=https://docs.docker.com/desktop/install/windows-install/>https://docs.docker.com/desktop/install/windows-install/</a></li><li>Install on Linux
<a href=https://docs.docker.com/desktop/install/linux-install/>https://docs.docker.com/desktop/install/linux-install/</a></li></ul><p>Then you can pull the Docker Ruby image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker pull ruby:3-bullseye
</span></span></code></pre></div><p>This command will pull the Docker image Ruby with version 3 using
<a href=https://www.debian.org/releases/bullseye/>Debian codename &ldquo;bullseye&rdquo;</a>.</p><p>Now, save this file as <code>create-rails.sh</code> in your project directory.
For example, you create the project directory in <code>~/Project</code>, then save it as <code>~/Project/create-rails.sh</code>.</p><p>This is the script to install Rails version 7.0.4.2 and create new Rails project with name <code>rails-otel</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>gem install rails -v 7.0.4.2
</span></span><span style=display:flex><span>rails new rails-otel
</span></span></code></pre></div><p>Then we can create a Rails project by running this command in your project directory (from the same location where you save the <code>create-rails.sh</code> file):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/rails-otel:/rails-otel -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/create-rails.sh:/create-rails.sh:ro ruby:3-bullseye /bin/bash create-rails.sh
</span></span></code></pre></div><p>Above command will tell Docker to run Docker image <code>ruby:3-bullseye</code> by mounting two volumes:</p><ul><li><code>$(pwd)/rails-otel:/rails-otel</code> means that we will make any files written by Docker container to persist in our host machine.</li><li><code>$(pwd)/create-rails.sh:/create-rails.sh:ro</code> tells Docker to include the <code>create-rails.sh</code> file from host machine to the container with read only mode. This is file that we need to run inside the Docker container.</li></ul><p>Then argument <code>/bin/bash create-rails.sh</code> tells Docker to run that command inside the Docker container <code>ruby:3-bullseye</code>.</p><p>Now, in the project directory <code>~/Project</code> you will find new folder containing the Rails code in <code>~/Project/rails-otel</code>.</p><p>Yay! We have created a clean Rails project without installing Ruby and gem Rails in our host machine!</p><p><strong>You can see it in this commit:
<a href=https://github.com/yusufsyaifudin/rails-otel/commit/85406142488993b62615aa0b18351bfbb8d2a725>8540614</a></strong></p><h2 id=running-rails-using-docker>Running Rails using Docker
<a class=anchor href=#running-rails-using-docker>#</a></h2><p>Now, we already have clean Ruby on Rails project, and it will means nothing if we don&rsquo;t run it. Again, since we don&rsquo;t install any Ruby nor <code>gem install rails</code> in our host machine, we need to run it using Docker too.</p><p>First, create a file with name <code>entrypoint.sh</code> in the Rails project:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Remove a potentially pre-existing server.pid for Rails.</span>
</span></span><span style=display:flex><span>rm -f /myapp/tmp/pids/server.pid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Then exec the container&#39;s main process (what&#39;s set as CMD in the Dockerfile).</span>
</span></span><span style=display:flex><span>exec <span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>As you can read in the comment, it needed to remove any potential pre-existing server.pid for Rails to run.</p><p>Then, create another file named <code>development.Docker</code> in the root Rails project directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ruby:3-bullseye</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update -qq<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Set workdir to &#34;myapp&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /myapp</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Copy Gemfile and download all Gem required to run.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># This minimize the build time because `bundle` doesn&#39;t need to scan all source code.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> Gemfile /myapp/Gemfile<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> Gemfile.lock /myapp/Gemfile.lock<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> bundle install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Add a script to be executed every time the container starts.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> entrypoint.sh /usr/bin/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /usr/bin/entrypoint.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 3000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>What we do here is copying <code>Gemfile</code> and <code>Gemfile.lock</code> into Docker container with base image <code>ruby:3-bullseye</code>.
After that, we run <code>bundle install</code> to download all <code>gem</code> dependencies required by our Rails application to run.</p><p>Then, we copy <code>entrypoint.sh</code> make it executable by apply <code>chmod +x</code> permission into it and make it as
<a href=https://docs.docker.com/engine/reference/builder/#entrypoint>Docker <code>ENTRYPOINT</code></a>. We also add <code>EXPOSE 3000</code> to tell Docker to expose port number 3000.</p><p>You may ask where we put the rest of our Ruby code? Why it didn&rsquo;t <code>COPY</code>ed to container?</p><p>The answer of this question is: No, we didn&rsquo;t need to copy our file into Docker container. Because, in this part what we <strong>only need</strong> is to run Rails application inside Docker container, and we can modify the code via any IDE installed in our host. In this part, our goal is not to make final Docker image to be deployed somewhere, but we use Docker as our development environment.</p><p>Finally, to make easier to run, we can use Docker Compose by creating new file named <code>docker-compose.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.8&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>myapp</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>development.Dockerfile</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec rails s -p 3000 -b &#39;0.0.0.0&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;3000:3000&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./:/myapp</span>
</span></span></code></pre></div><p>In above code, we name our Rails application as <code>myapp</code> with Dockerfile referenced to the file <code>development.Dockerfile</code> we have created above. Then we mount the volume <code>./:/myapp</code> which means that <code>myapp</code> service will have access of all files in the host current directory and mapped it into <code>/myapp</code> directory inside the Docker container.</p><p>Then we need to run command <code>bundle exec rails s -p 3000 -b '0.0.0.0'</code> for Rails application to run in port 3000.</p><p>After creating those 3 files (<code>Dockerfile</code>, <code>entrypoint.sh</code> and <code>docker-compose.yml</code>) we can run our Rails app by executing this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose up --build --force-recreate
</span></span></code></pre></div><p>We will see our terminal similar like this:</p><p><img src=/blog/post-assets/2023-02-24/run-rails-using-docker-compose.png alt="Figure 1. Running Rails using Docker Compose"></p><div style=text-align:center;margin-top:-40px;margin-bottom:30px>Figure 1. Running Rails using Docker Compose</div><p>Now, access your browser at <code>http://localhost:3000</code> it should look like this:</p><p><img src=/blog/post-assets/2023-02-24/rails-homepage-fresh-install.png alt="Figure 2. RoR homepage on fresh install"></p><div style=text-align:center;margin-top:-40px;margin-bottom:30px>Figure 2. RoR homepage on fresh install</div><p><strong>You can see all changes of this section on this commit:
<a href=https://github.com/yusufsyaifudin/rails-otel/commit/1502a09818336d30d47916ecb7959725a9177532>1502a09</a></strong></p><h1 id=add-route-mimicking-nested-function-calls-operation>Add route mimicking nested function calls operation
<a class=anchor href=#add-route-mimicking-nested-function-calls-operation>#</a></h1><p>As this article is focusing on <strong>how we can get better observability of the logs emitted by Rails application,</strong> we need add one route in our router that do nested function calls. This mimicking the real-world application, where one API may do several function calls (or sometimes 3rd party call) before it return response to the user.</p><p>For this tutorial, I will create a router where user can apply a Voucher code. I will create the route:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>GET /list-vouchers?token<span style=color:#f92672>=</span>jwt-token
</span></span></code></pre></div><p>Which will return list of promotion voucher code that can only be accessed by the user (so we need to check whether the user is exists in database or not).</p><p>The response will looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;user&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;f2c2d7ba-0d2b-4f2d-8a6c-6b3a69c8d87e&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;a&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;a&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;created_at&#34;</span>: <span style=color:#e6db74>&#34;2023-02-28T11:08:36.000Z&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;updated_at&#34;</span>: <span style=color:#e6db74>&#34;2023-02-28T11:08:38.000Z&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;vouchers&#34;</span>: [
</span></span><span style=display:flex><span>      [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;voucher_code&#34;</span>: <span style=color:#e6db74>&#34;REGISTER_ANNIVERSARY&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;will get 5% discount if user is a loyal users (already joined minimum 1 year)&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;terms_and_conditions&#34;</span>: [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;discount&#34;</span>: <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;min_registered_year&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;registered_date_is_same&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;registered_month_is_same&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;name_prefix&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>In this process, we need to:</p><ol><li>Get the Authorization token, either from Header or query params.</li><li>Parse the JWT, and get the user id from token.</li><li>Check if the user id is exists on the database.</li><li>Call service Promotions (for now we create a Class that return static output) if user is exist in database, otherwise return error.</li></ol><blockquote><p>This article only focus to show you how to create better logging, so there is may security hole in the code.</p></blockquote><p>Let&rsquo;s code that!</p><h2 id=preparing-postgres-database-and-gem-library-to-connect>Preparing Postgres Database and Gem Library To Connect
<a class=anchor href=#preparing-postgres-database-and-gem-library-to-connect>#</a></h2><p>Before we create any Ruby code, we need a database to be use by our code. We use Postgres 15 using Docker.</p><p>First, stop our previous docker run command (<code>docker compose up --build --force-recreate</code>) in the terminal by using <code>CTRL + C</code>.
Then command <code>docker compose down</code> to make sure all container is stopped.</p><p>Then, in our <code>docker-compose.yml</code> file, change to this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.8&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>myapp</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>development.Dockerfile</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec rails s -p 3000 -b &#39;0.0.0.0&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;3000:3000&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./:/myapp</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>DATABASE_USERNAME</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>DATABASE_PASSWORD</span>: <span style=color:#ae81ff>password</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>postgres</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:15</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;5433:5432&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_USER=root</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_PASSWORD=password</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_DB=postgres</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_INITDB_ARGS=&#34;--data-checksums&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./docker-data/postgres:/var/lib/postgresql/data</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./docker-postgres-init.sql:/docker-entrypoint-initdb.d/docker-postgres-init.sql:ro</span>
</span></span></code></pre></div><p>This will tell Docker to add new container <code>postgres:15</code> with username <code>root</code> and password <code>password</code>. And passing this credentials to <code>myapp</code> container.</p><p>Then, as we specified in the <code>volumes</code> section, we need to create a file with name <code>docker-postgres-init.sql</code> in our root project directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> rails_otel_dev;
</span></span><span style=display:flex><span><span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>ALL</span> <span style=color:#66d9ef>PRIVILEGES</span> <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DATABASE</span> rails_otel_dev <span style=color:#66d9ef>TO</span> root;
</span></span></code></pre></div><p>This will tell the Postgres to create 3 databases (<code>rails_otel_dev</code>, <code>rails_otel_test</code>, and <code>rails_otel_prod</code>) when first run.
All data will be persisted in <code>./docker-data/postgres</code> as we mount our Docker volume into it.</p><p>Don&rsquo;t forget to add <code>docker-data</code> in the <code>.gitignore</code> to ensure that all data created by Postgres is not committed to our Git repo.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>  37 # Ignore IDE index file
</span></span><span style=display:flex><span>  38 /.idea
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ 39 docker-data
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>  40
</span></span></code></pre></div><p>Then, to make our Rails application can connect to Postgres, we need to add <code>pg</code> Gem library, by adding to the <code>Gemfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>  50
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ 51 # Pg is the Ruby interface to the PostgreSQL RDBMS. It works with PostgreSQL 9.3 and later.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 52 gem &#39;pg&#39;, &#39;~&gt; 1.4&#39;, &#39;&gt;= 1.4.6&#39;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>  53
</span></span></code></pre></div><p>Lastly, in change the <code>config/database.yml</code> file with this configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>default</span>: <span style=color:#75715e>&amp;default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>adapter</span>: <span style=color:#ae81ff>postgresql</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>encoding</span>: <span style=color:#ae81ff>unicode</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>pool</span>: <span style=color:#ae81ff>&lt;%= ENV.fetch(&#34;RAILS_MAX_THREADS&#34;) { 5 } %&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>host</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>username</span>: <span style=color:#ae81ff>&lt;%= ENV[&#39;DATABASE_USERNAME&#39;] %&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>password</span>: <span style=color:#ae81ff>&lt;%= ENV[&#39;DATABASE_PASSWORD&#39;] %&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>development</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>database</span>: <span style=color:#ae81ff>&lt;%= ENV[&#39;DATABASE_DB_NAME&#39;] %&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Warning: The database defined as &#34;test&#34; will be erased and</span>
</span></span><span style=display:flex><span><span style=color:#75715e># re-generated from your development database when you run &#34;rake&#34;.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Do not set this db to the same as development or production.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>test</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>database</span>: <span style=color:#ae81ff>&lt;%= ENV[&#39;DATABASE_DB_NAME&#39;] %&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>production</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;&lt;</span>: <span style=color:#75715e>*default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>database</span>: <span style=color:#ae81ff>&lt;%= ENV[&#39;DATABASE_DB_NAME&#39;] %&gt;</span>
</span></span></code></pre></div><details><summary>git diff</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>- # SQLite. Versions 3.8.0 and up are supported.
</span></span></span><span style=display:flex><span><span style=color:#f92672>- #   gem install sqlite3
</span></span></span><span style=display:flex><span><span style=color:#f92672>- #
</span></span></span><span style=display:flex><span><span style=color:#f92672>- #   Ensure the SQLite 3 gem is defined in your Gemfile
</span></span></span><span style=display:flex><span><span style=color:#f92672>- #   gem &#34;sqlite3&#34;
</span></span></span><span style=display:flex><span><span style=color:#f92672>- #
</span></span></span><span style=display:flex><span><span style=color:#f92672></span>default: &amp;default
</span></span><span style=display:flex><span><span style=color:#f92672>-  adapter: sqlite3
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+  adapter: postgresql
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  encoding: unicode
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>  pool: &lt;%= ENV.fetch(&#34;RAILS_MAX_THREADS&#34;) { 5 } %&gt;
</span></span><span style=display:flex><span>  timeout: 5000
</span></span><span style=display:flex><span><span style=color:#a6e22e>+  host: postgres
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  port: 5432
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  username: &lt;%= ENV[&#39;DATABASE_USERNAME&#39;] %&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  password: &lt;%= ENV[&#39;DATABASE_PASSWORD&#39;] %&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>development:
</span></span><span style=display:flex><span>  &lt;&lt;: *default
</span></span><span style=display:flex><span><span style=color:#f92672>-  database: db/development.sqlite3
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+  database: &lt;%= ENV[&#39;DATABASE_DB_NAME&#39;] %&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span># Warning: The database defined as &#34;test&#34; will be erased and
</span></span><span style=display:flex><span># re-generated from your development database when you run &#34;rake&#34;.
</span></span><span style=display:flex><span># Do not set this db to the same as development or production.
</span></span><span style=display:flex><span>test:
</span></span><span style=display:flex><span>  &lt;&lt;: *default
</span></span><span style=display:flex><span><span style=color:#f92672>- database: db/test.sqlite3
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+ database: &lt;%= ENV[&#39;DATABASE_DB_NAME&#39;] %&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span>production:
</span></span><span style=display:flex><span>  &lt;&lt;: *default
</span></span><span style=display:flex><span><span style=color:#f92672>- database: db/production.sqlite3
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+ database: &lt;%= ENV[&#39;DATABASE_DB_NAME&#39;] %&gt;
</span></span></span></code></pre></div></details><p>In the above configuration, we connect to Postgres with hostname <code>postgres</code> (because we run in the internal Docker network).</p><p>Lastly, to ensure we already install and connected with to Postgres, we can run the Docker run command again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose up --build --force-recreate
</span></span></code></pre></div><p>Now, try to access or hard refresh <code>http://localhost:3000</code> again, it should still return the Rails homepage as shown in Figure 2 above.</p><p><strong>You can see all these changes in this section here:
<a href=https://github.com/yusufsyaifudin/rails-otel/commit/853fda5f700d1eda431a222d044717764219e3a3>853fda5</a></strong></p><h2 id=creating-users-table-and-connecting-using-active-record>Creating Users Table and Connecting Using Active Record
<a class=anchor href=#creating-users-table-and-connecting-using-active-record>#</a></h2><p>In the terminal run this command to create a database migration files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose run --no-deps myapp rails generate migration EnableUUIDExt
</span></span></code></pre></div><p>And</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose run --no-deps myapp rails generate migration CreateUsersTable
</span></span></code></pre></div><p>You will get two new files:</p><ul><li><code>db/migrate/20230228035405_enable_uuid_ext.rb</code></li><li><code>db/migrate/20230228035420_create_users_table.rb</code></li></ul><blockquote><p>Please note that the prefix value (20230228035405 or 20230228035420) is the current timestamp when you run the command.
You don&rsquo;t need to be careful of that, because the important things is the file content.</p></blockquote><p>In the <code>db/migrate/20230228035405_enable_uuid_ext.rb</code> replace the file content with this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EnableUuidExt</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Migration</span><span style=color:#f92672>[</span><span style=color:#ae81ff>7</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>change</span>
</span></span><span style=display:flex><span>    enable_extension <span style=color:#e6db74>&#34;uuid-ossp&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This will tell Rails to create a <code>uuid-ossp</code> extensions, similar like we run this query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> EXTENSION <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#e6db74>&#34;uuid-ossp&#34;</span>;
</span></span></code></pre></div><p>And in the file <code>db/migrate/20230228035420_create_users_table.rb</code> replace the file content to this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CreateUsersTable</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Migration</span><span style=color:#f92672>[</span><span style=color:#ae81ff>7</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>up</span>
</span></span><span style=display:flex><span>    create_table <span style=color:#e6db74>:users</span>, <span style=color:#e6db74>:id</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>t<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      t<span style=color:#f92672>.</span>column <span style=color:#e6db74>:id</span>, <span style=color:#e6db74>&#39;uuid&#39;</span>, <span style=color:#e6db74>:null</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span>, <span style=color:#e6db74>:primary_key</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>:default</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;uuid_generate_v4()&#34;</span>
</span></span><span style=display:flex><span>      t<span style=color:#f92672>.</span>string <span style=color:#e6db74>:username</span>, <span style=color:#e6db74>:null</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      t<span style=color:#f92672>.</span>string <span style=color:#e6db74>:name</span>, <span style=color:#e6db74>:null</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span>, <span style=color:#e6db74>:default</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>      t<span style=color:#f92672>.</span>timestamps
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    add_index <span style=color:#e6db74>:users</span>, <span style=color:#e6db74>:username</span>, <span style=color:#e6db74>unique</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>down</span>
</span></span><span style=display:flex><span>      drop_table <span style=color:#e6db74>:users</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Then run this command in the terminal to create the table in Postgres database:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose run --no-deps myapp rails db:migrate
</span></span></code></pre></div><p>You will get the output similar like this:</p><p><img src=/blog/post-assets/2023-02-24/rails-db-migrate-users.png alt="Figure 3. Database Migration For Users Table"></p><div style=text-align:center;margin-bottom:30px>Figure 3. Database Migration For Users Table</div><p>To verify that our database migration is applied in our Postgres container, run this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose run --no-deps postgres psql -U root -h postgres rails_otel_dev
</span></span></code></pre></div><p>Type the password which is <code>password</code>, then run command <code>\d</code> inside it. We will see that we now have 3 tables:</p><ul><li>ar_internal_metadata</li><li>schema_migrations</li><li>users</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose run --no-deps postgres psql -U root -h postgres rails_otel_dev
</span></span><span style=display:flex><span>Password <span style=color:#66d9ef>for</span> user root:
</span></span><span style=display:flex><span>psql <span style=color:#f92672>(</span>15.2 <span style=color:#f92672>(</span>Debian 15.2-1.pgdg110+1<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#34;help&#34;</span> <span style=color:#66d9ef>for</span> help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rails_otel_dev<span style=color:#f92672>=</span><span style=color:#75715e># \d</span>
</span></span><span style=display:flex><span>               List of relations
</span></span><span style=display:flex><span> Schema |         Name         | Type  | Owner
</span></span><span style=display:flex><span>--------+----------------------+-------+-------
</span></span><span style=display:flex><span> public | ar_internal_metadata | table | root
</span></span><span style=display:flex><span> public | schema_migrations    | table | root
</span></span><span style=display:flex><span> public | users                | table | root
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#ae81ff>3</span> rows<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rails_otel_dev<span style=color:#f92672>=</span><span style=color:#75715e>#</span>
</span></span></code></pre></div><p><strong>You can see all these changes in this section here:
<a href=https://github.com/yusufsyaifudin/rails-otel/commit/c707a258a9820e48053a4c1ae676bac7e0100556>c707a25</a></strong></p><h2 id=creating-services-jwt-encoderdecoder-and-controller>Creating Services, JWT encoder/decoder, and Controller
<a class=anchor href=#creating-services-jwt-encoderdecoder-and-controller>#</a></h2><p>In this section, I will go straightforward of what code we need to write.
This is because the article already long enough, and we still don&rsquo;t get to the main part where we should change our log output to get better observability. So, I may not write long explanation about what the code is doing, and just put the file name and code.</p><p>Now, we need to create model to interact with our table in file <code>app/models/user.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ApplicationRecord</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This is for Rails application to interact with the <code>users</code> table we create before.</p><p>Then create a file in <code>app/externals/promotions/promotion_service.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> Promotions
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PromotionService</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>list_vouchers</span>()
</span></span><span style=display:flex><span>            <span style=color:#75715e># random sleep from 100ms to 500ms</span>
</span></span><span style=display:flex><span>            s <span style=color:#f92672>=</span> (rand(<span style=color:#ae81ff>100</span><span style=color:#f92672>...</span><span style=color:#ae81ff>500</span>)<span style=color:#f92672>.</span>to_f<span style=color:#f92672>/</span><span style=color:#ae81ff>1000</span>)<span style=color:#f92672>.</span>to_f <span style=color:#75715e># divide by 1000 to get millisecond</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;PromotionService.list_vouchers call started&#34;</span>
</span></span><span style=display:flex><span>            sleep(s)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;PromotionService.list_vouchers done&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;voucher_code&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;REGISTER_ANNIVERSARY&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;description&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;will get 5% discount if user is a loyal users (already joined minimum 1 year)&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;terms_and_conditions&#39;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;discount&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;min_registered_year&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;registered_date_is_same&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;registered_month_is_same&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;name_prefix&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;voucher_code&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;I_AM_JAN&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;description&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;will get 1% discount if user have name prefix &#39;jan&#39; because our app is launched at January!&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;terms_and_conditions&#39;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;discount&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;min_registered_year&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;registered_date_is_same&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;registered_month_is_same&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;name_prefix&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This to mimicking external service that we need to call via network (either HTTP or gRPC, and that&rsquo;s the reason why I put it under <code>app/externals</code> directory). Supposed that we designed our system using microservice architecture, we may split into several separated service and we call it from main application. But, instead writing some real another service and call it, in this section I write a hard-coded object in class <code>PromotionService</code> that mimicking the response of the Promotions service when we request list of voucher code. Since this code will never return error, I added some <code>sleep</code> operation mimicking the network call latency and some logger before and after it.</p><p>Now, create another file <code>app/services/vouchers/user_voucher.rb</code> that do the main business logic:</p><ol><li>Get user information from database</li><li>Call the <code>PromotionService</code> above and return the user object and list of vouchers.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> Vouchers
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserVoucher</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>vouchers</span>(user_id)
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;reaching business logic&#34;</span>
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;doing query get user by id </span><span style=color:#e6db74>#{</span>user_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>           user <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>::</span>find_by(<span style=color:#e6db74>:id</span> <span style=color:#f92672>=&gt;</span> user_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>throw</span> <span style=color:#e6db74>:NotFoundUser</span> <span style=color:#66d9ef>if</span> user<span style=color:#f92672>.</span>nil?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;calling PromotionService.list_vouchers from UserVoucher.list_vouchers </span><span style=color:#e6db74>#{</span>user_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>           vouchers <span style=color:#f92672>=</span> <span style=color:#66d9ef>Promotions</span><span style=color:#f92672>::</span><span style=color:#66d9ef>PromotionService</span><span style=color:#f92672>::</span>list_vouchers()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>return</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#39;user&#39;</span> <span style=color:#f92672>=&gt;</span> user,
</span></span><span style=display:flex><span>               <span style=color:#e6db74>&#39;vouchers&#39;</span> <span style=color:#f92672>=&gt;</span> vouchers
</span></span><span style=display:flex><span>           <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Now, we need to create a library for encoding and decoding the Json Web Token. To do that, we need to install some <code>gem</code> in our <code>Gemfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>  53
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ 54 # A pure ruby implementation of the RFC 7519 OAuth JSON Web Token (JWT) standard.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 55 gem &#39;jwt&#39;, &#39;~&gt; 2.7&#39;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 56 
</span></span></span></code></pre></div><p>We install library <code>jwt</code> to decode and encode the JWT.</p><p>Then create a file <code>lib/json_web_token.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>JsonWebToken</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>encode</span>(payload)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>JWT</span><span style=color:#f92672>.</span>encode(payload, <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>application<span style=color:#f92672>.</span>secrets<span style=color:#f92672>.</span>secret_key_base)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span>(token)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;validating JWT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>JWT</span><span style=color:#f92672>.</span>decode(token, <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>application<span style=color:#f92672>.</span>secrets<span style=color:#f92672>.</span>secret_key_base)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>rescue</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Now, let&rsquo;s create the controller and route for it.</p><p>We need add library <code>responders</code> since we need <code>respond_to</code> method that
<a href=https://stackoverflow.com/a/15290199>are no longer a part of Rails</a>. In <code>Gemfile</code> add this line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a6e22e>+ 56
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 57 # A set of Rails responders to dry up your application
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 58 gem &#39;responders&#39;, &#39;~&gt; 3.1&#39;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 59
</span></span></span></code></pre></div><p>Then change the file <code>app/controllers/application_controller.rb</code> into this to register the function loaded in controllers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>  1 class ApplicationController &lt; ActionController::Base
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ 2    include ActionController::MimeResponds
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>  3 end
</span></span><span style=display:flex><span>  4
</span></span></code></pre></div><p>After that, create the controller file <code>app/controllers/UserPromotionController.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require_dependency <span style=color:#e6db74>&#34;json_web_token&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserPromotionController</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ApplicationController</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>list_vouchers</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;request accepted by controller&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>          token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>          auth <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>headers<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;Authorization&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>auth<span style=color:#f92672>.</span>nil?
</span></span><span style=display:flex><span>            token <span style=color:#f92672>=</span> auth<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39; &#39;</span>)<span style=color:#f92672>.</span>last
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> token<span style=color:#f92672>.</span>empty?
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;accepting token from query params&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            token <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>query_parameters<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;token&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;accepting token from headers&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          token_extracted <span style=color:#f92672>=</span> <span style=color:#66d9ef>JsonWebToken</span><span style=color:#f92672>::</span>decode(token)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> token_extracted<span style=color:#f92672>.</span>nil? <span style=color:#f92672>||</span> token_extracted<span style=color:#f92672>.</span>to_a<span style=color:#f92672>.</span>length() <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> respond_to <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>format<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>              format<span style=color:#f92672>.</span>any {render <span style=color:#e6db74>:json</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;message&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;nil extracted token&#39;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>]</span>}
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          jwt_payload <span style=color:#f92672>=</span> token_extracted<span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> jwt_payload<span style=color:#f92672>.</span>nil?
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> respond_to <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>format<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>              format<span style=color:#f92672>.</span>any {render <span style=color:#e6db74>:json</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;message&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;nil jwt payload&#39;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>]</span>}
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          user_id <span style=color:#f92672>=</span> jwt_payload<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;user_id&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> user_id<span style=color:#f92672>.</span>nil? <span style=color:#f92672>||</span> user_id<span style=color:#f92672>.</span>empty?
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> respond_to <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>format<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>               format<span style=color:#f92672>.</span>any {render <span style=color:#e6db74>:json</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>&#39;message&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;empty user id from jwt payload&#39;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>]</span>}
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          out <span style=color:#f92672>=</span> <span style=color:#66d9ef>Vouchers</span><span style=color:#f92672>::</span><span style=color:#66d9ef>UserVoucher</span><span style=color:#f92672>::</span>vouchers(user_id)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;controller done processing the request, preparing rendering response&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> respond_to <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>format<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>            format<span style=color:#f92672>.</span>any {render <span style=color:#e6db74>:json</span> <span style=color:#f92672>=&gt;</span> out}
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>rescue</span> <span style=color:#f92672>=&gt;</span> err
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> respond_to <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>format<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>            format<span style=color:#f92672>.</span>any  {render <span style=color:#e6db74>:json</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;message&#39;</span>: err
</span></span><span style=display:flex><span>            <span style=color:#f92672>]</span>}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span> <span style=color:#75715e># end of begin-rescue</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Now, we have our controller that accept token (JWT) via header or query params <code>token</code>, then encode it using <code>JsonWebToken::decode(token)</code> that we create in <code>lib/json_web_token.rb</code> to get the <code>user_id</code>. After that we pass this <code>user_id</code> to <code>UserVoucher::vouchers(user_id)</code> which we defined in <code>app/services/vouchers/user_voucher.rb</code>.</p><p>But, this controller cannot be accessed until we register the routes.</p><h2 id=registering-routes>Registering Routes
<a class=anchor href=#registering-routes>#</a></h2><p>First, we need to make sure all our previous code loaded by Rails by adding this line in <code>config/application.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>config<span style=color:#f92672>.</span>watchable_dirs<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;lib&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>:rb</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Then register our controller in <code>config/routes.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>get <span style=color:#e6db74>&#39;list-vouchers&#39;</span>, <span style=color:#e6db74>to</span>: <span style=color:#e6db74>&#39;user_promotion#list_vouchers&#39;</span>
</span></span></code></pre></div><p>Done! Please re-run the command <code>docker compose up --build --force-recreate</code> again. It will install the library <code>jwt</code> and <code>responders</code>.</p><p>Now we have the routes that can be accessed
<a href="http://localhost:3000/list-vouchers?token=jwt.access.token">http://localhost:3000/list-vouchers?token=jwt.access.token</a>. But, we don&rsquo;t have any real user saved in our Postgres and we don&rsquo;t have any JSON Web Token yet. Let&rsquo;s go to next section!</p><p><strong>You can see changes in this section here:
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/c85c199c3a46ddb0a245f4ccd340bf5850fa17dd?diff=split">c85c199</a></strong></p><h2 id=insert-user-data-and-create-jwt-access-token-via-rails-console>Insert User data and Create JWT access token via <code>rails console</code>
<a class=anchor href=#insert-user-data-and-create-jwt-access-token-via-rails-console>#</a></h2><p>We can invoke and run any code of our code by launching the <code>rails console</code>. Since we are using Docker for our development tools, we can run <code>rails console</code> inside the container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose run --no-deps myapp rails console
</span></span></code></pre></div><p>Then, to insert the User with username <code>jane</code> and name <code>Jane Kepiye Karepe To</code> we can run this code inside the <code>rails console</code> launched by previous command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>::</span>create(<span style=color:#e6db74>username</span>: <span style=color:#e6db74>&#34;jane&#34;</span>, name: <span style=color:#e6db74>&#34;Jane Kepiye Karepe To&#34;</span>)
</span></span></code></pre></div><p>Then continue with running this command to get the previous inserted user and generate JWT token:</p><blockquote><p>Note: run this line by line.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>u <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>::</span>find_by(<span style=color:#e6db74>username</span>: <span style=color:#e6db74>&#34;jane&#34;</span>)
</span></span><span style=display:flex><span>require_dependency <span style=color:#e6db74>&#34;json_web_token&#34;</span>
</span></span><span style=display:flex><span>token <span style=color:#f92672>=</span> <span style=color:#66d9ef>JsonWebToken</span><span style=color:#f92672>::</span>encode({<span style=color:#e6db74>user_id</span>: u<span style=color:#f92672>.</span>id})
</span></span></code></pre></div><p>You will get the output something like this:</p><p><img src=/blog/post-assets/2023-02-24/rails-console-insert-user-and-generate-jwt.png alt="Figure 4. Insert user and generate JWT"></p><div style=text-align:center;margin-bottom:30px>Figure 4. Insert user and generate JWT</div><p>In this example, you get the JWT token. Your generated token may be different, use your own token!</p><pre tabindex=0><code>eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYzhjNjk5MWMtNjg3ZS00NGNjLTg3NTUtNDc0M2VmNjZkMjY1In0.TCrEUFziQY4800jAT9ioY2mOm_b9eLdC20gtXjdTt14
</code></pre><h2 id=accessing-the-routes>Accessing the routes
<a class=anchor href=#accessing-the-routes>#</a></h2><p>You can access the page
<a href="http://localhost:3000/list-vouchers?token=%7byour-token%7d">http://localhost:3000/list-vouchers?token={your-token}</a> which will return the JSON similar as shown in figure 5.</p><p><img src=/blog/post-assets/2023-02-24/rails-route-list-vouchers.png alt="Figure 5. Route /list-vouchers"></p><div style=text-align:center;margin-bottom:30px>Figure 5. Route /list-vouchers</div><p>Finally, we have a single route Rails application in this part. Then, we can go to
<a href=/posts/2023-02-24-rails-otel-part2/>Part 2</a> to learn what the problem we have if we use this code in high traffic and how to improve it.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/yusufsyaifudin/blog/commit/d18c9e6fa73c397c5479271ebb512fe5d97e5071 title='Last modified by Yusuf Syaifudin | December 27, 2023' target=_blank rel=noopener><img src=/blog/svg/calendar.svg class=book-icon alt=Calendar>
<span>December 27, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/yusufsyaifudin/blog/edit/main/content/posts/2023-02-24-rails-otel-part1.md target=_blank rel=noopener><img src=/blog/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#prepare-rails-application>Prepare Rails Application</a><ul><li><a href=#installing-rails>Installing Rails</a></li><li><a href=#running-rails-using-docker>Running Rails using Docker</a></li></ul></li><li><a href=#add-route-mimicking-nested-function-calls-operation>Add route mimicking nested function calls operation</a><ul><li><a href=#preparing-postgres-database-and-gem-library-to-connect>Preparing Postgres Database and Gem Library To Connect</a></li><li><a href=#creating-users-table-and-connecting-using-active-record>Creating Users Table and Connecting Using Active Record</a></li><li><a href=#creating-services-jwt-encoderdecoder-and-controller>Creating Services, JWT encoder/decoder, and Controller</a></li><li><a href=#registering-routes>Registering Routes</a></li><li><a href=#insert-user-data-and-create-jwt-access-token-via-rails-console>Insert User data and Create JWT access token via <code>rails console</code></a></li><li><a href=#accessing-the-routes>Accessing the routes</a></li></ul></li></ul></nav></div></aside></main></body></html>