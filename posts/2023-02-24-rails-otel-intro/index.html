<!doctype html><html lang=en dir=ltr><head><meta name=generator content="Hugo 0.121.1"><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Ruby on Rails (RoR) is a common framework used by Ruby developers when building web application. It ships with common libraries from logger to active record (for easily querying from database). But, like many current framework in others programming language, we need to write some extra code to make our application easier to observe and debug. For example, on small traffic application we may satisfied by printing some logging such as:"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID"><meta property="og:description" content="Ruby on Rails (RoR) is a common framework used by Ruby developers when building web application. It ships with common libraries from logger to active record (for easily querying from database). But, like many current framework in others programming language, we need to write some extra code to make our application easier to observe and debug. For example, on small traffic application we may satisfied by printing some logging such as:"><meta property="og:type" content="article"><meta property="og:url" content="https://yusufsyaifudin.github.io/blog/posts/2023-02-24-rails-otel-intro/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-24T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-27T08:25:25+07:00"><title>Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID | yusuf's blog</title>
<link rel=manifest href=/blog/manifest.json><link rel=icon href=/blog/favicon.png type=image/x-icon><link rel=stylesheet href=/blog/book.min.68be0b7a9674f2a612ce0e9b2e9447ff4b7ac96546e06b642bfd3ded0ca490ef.css integrity="sha256-aL4LepZ08qYSzg6bLpRH/0t6yWVG4GtkK/097QykkO8="><script defer src=/blog/en.search.min.e7fa058893811212add3ba5904d8fc50bcfeb5a871faa0e25e208271807b8599.js integrity="sha256-5/oFiJOBEhKt07pZBNj8ULz+tahx+qDiXiCCcYB7hZk="></script><script defer src=/blog/sw.min.e30dcfc647efc866455c67b26b2aabda17816f06fe2dd202ac21b4422180bd9b.js integrity="sha256-4w3PxkfvyGZFXGeyayqr2heBbwb+LdICrCG0QiGAvZs="></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/blog><span>yusuf's blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/blog/posts/>Blog</a></li><li><a href=https://github.com/yusufsyaifudin target=_blank rel=noopener>My Github</a></li><li><a href=https://github.com/alex-shpak/hugo-book target=_blank rel=noopener>Hugo Theme</a></li></ul></nav><script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/blog/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID</strong>
<label for=toc-control><img src=/blog/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#the-problem>The Problem</a></li><li><a href=#using-opentelemetry-to-trace-user-journey>Using OpenTelemetry to Trace User Journey</a></li><li><a href=#using-json-as-the-log-format-output>Using JSON as the Log Format Output</a></li><li><a href=#part-1-preparing-the-ruby-on-rails-application>Part 1: Preparing the Ruby on Rails Application</a></li><li><a href=#part-2-improving-log-output>Part 2: Improving Log Output</a></li></ul></nav></aside></header><article class=markdown><h1><a href=/blog/posts/2023-02-24-rails-otel-intro/>Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID</a></h1><h5>February 24, 2023</h5><div><a href=/blog/categories/tutorials/>tutorials</a></div><div><a href=/blog/tags/ruby/>ruby</a>,
<a href=/blog/tags/rails/>rails</a>,
<a href=/blog/tags/opentelemetry/>opentelemetry</a></div><p>Ruby on Rails (RoR) is a common framework used by Ruby developers when building web application. It ships with common libraries from logger to active record (for easily querying from database). But, like many current framework in others programming language, we need to write some extra code to make our application easier to observe and debug. For example, on small traffic application we may satisfied by printing some logging such as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>myapp  | Started GET <span style=color:#e6db74>&#34;/list-vouchers&#34;</span> <span style=color:#66d9ef>for</span> 192.168.32.1 at 2023-03-09 03:26:00 +0000
</span></span><span style=display:flex><span>myapp  | Cannot render console from 192.168.32.1! Allowed networks: 127.0.0.0/127.255.255.255, ::1
</span></span><span style=display:flex><span>myapp  |   ActiveRecord::SchemaMigration Pluck <span style=color:#f92672>(</span>1.8ms<span style=color:#f92672>)</span>  SELECT <span style=color:#e6db74>&#34;schema_migrations&#34;</span>.<span style=color:#e6db74>&#34;version&#34;</span> FROM <span style=color:#e6db74>&#34;schema_migrations&#34;</span> ORDER BY <span style=color:#e6db74>&#34;schema_migrations&#34;</span>.<span style=color:#e6db74>&#34;version&#34;</span> ASC
</span></span><span style=display:flex><span>myapp  | Processing by UserPromotionController#list_vouchers as HTML
</span></span><span style=display:flex><span>myapp  | request accepted by controller
</span></span><span style=display:flex><span>myapp  | accepting token from headers
</span></span><span style=display:flex><span>myapp  | validating JWT
</span></span><span style=display:flex><span>myapp  | reaching business logic
</span></span><span style=display:flex><span>myapp  | doing query get user by id c8c6991c-687e-44cc-8755-4743ef66d265
</span></span><span style=display:flex><span>myapp  |   User Load <span style=color:#f92672>(</span>2.2ms<span style=color:#f92672>)</span>  SELECT <span style=color:#e6db74>&#34;users&#34;</span>.* FROM <span style=color:#e6db74>&#34;users&#34;</span> WHERE <span style=color:#e6db74>&#34;users&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> $1 LIMIT $2  <span style=color:#f92672>[[</span><span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span><span style=color:#f92672>]</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;LIMIT&#34;</span>, 1<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>myapp  |   â†³ app/services/vouchers/user_voucher.rb:7:in <span style=color:#e6db74>`</span>vouchers<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>myapp  | calling PromotionService.list_vouchers from UserVoucher.list_vouchers c8c6991c-687e-44cc-8755-4743ef66d265
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers call started
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>myapp  | controller <span style=color:#66d9ef>done</span> processing the request, preparing rendering response
</span></span><span style=display:flex><span>myapp  | Completed <span style=color:#ae81ff>200</span> OK in 314ms <span style=color:#f92672>(</span>Views: 12.1ms | ActiveRecord: 9.0ms | Allocations: 8720<span style=color:#f92672>)</span>
</span></span></code></pre></div><blockquote><p>This log is taken from the code from the Rails app that I write in part 1.</p></blockquote><p>But, as our web application traffic become heavy, it will become hard to pinpoint on specific user&rsquo;s request journey.</p><p>Let me tell you why this will become the problem and how we can improve this.</p><p>Supposed you have 16 line of log above, repeated multiple times because of high traffic, then:</p><ul><li>How you can ensure that the next line of the log is sequentially correspond with the previous line?</li><li>How you will group the log based on one request journey?</li><li>How can we sorting by time? It is text based, then if you successfully sort that, it probably you&rsquo;re sorting the whole line (not specific by time).</li><li>And another question on how we get the better sense of the log.</li></ul><h1 id=the-problem>The Problem
<a class=anchor href=#the-problem>#</a></h1><p>The default Rails log output is hard to debug. I think it is not only me who feel that. Even ChatGPT tell me this when I asked <strong>why rails app log hard to debug</strong>:</p><p>![Figure 1. ChatGPT&rsquo;s opinion of Rails log outputs]( {{ absLangURL &ldquo;/post-assets/2023-02-24/chatgpt-why-rails-app-log-hard-to-debug.png&rdquo; }} )</p><div style=text-align:center;margin-bottom:30px>Figure 1. ChatGPT's opinion of Rails log outputs</div><hr><blockquote><p><small>Below is the ChatGPT generated text</small></p></blockquote><p>Rails app logs can be hard to debug for several reasons:</p><ol><li>Complexity: Rails applications can be complex with many layers of code that interact with each other. This can make it difficult to pinpoint the root cause of an issue.</li><li>Volume: Rails logs can generate a large volume of information, making it difficult to find the relevant information needed to debug an issue.</li><li>Lack of structure: Rails logs can lack structure, making it difficult to identify the relevant information needed to debug an issue.</li><li>Lack of context: Rails logs may not provide enough context to understand the flow of the application, making it difficult to understand how the different parts of the application are interacting.</li><li>Lack of tooling: Traditional text editors or command line tools may not be well suited for analyzing logs, and dedicated log analysis tools can be expensive or require specialized knowledge.</li></ol><p>To make Rails app logs easier to debug, developers can:</p><ol><li>Use logging frameworks like Lograge or Semantic Logger that provide more structure and context to logs.</li><li>Configure logging to only include relevant information and to filter out noise.</li><li>Use log analysis tools like Elasticsearch or Splunk to search, filter, and analyze logs.</li><li>Implement error tracking tools like Sentry or Airbrake to automatically capture and group errors and provide context for debugging.</li><li>Use logging libraries like Pry or Byebug to interactively debug code during runtime.</li></ol><blockquote><p><small>End of ChatGPT generated text</small></p></blockquote><hr><p>In this part, I will not talk much about it. I will explain why it become problem in
<a href=/blog/posts/2023-02-24-rails-otel-part2/>the Part 2</a> with an example and then try to solve it. But, before jump to solution, I must prepare the clean Rails Application in
<a href=/posts/2023-02-24-rails-otel-part1/>the Part 1</a> as I haven&rsquo;t touch the Ruby on Rails for years.</p><p>Each section on each part will always include with the specific commit id. It will help you (and me in the future) to follow the tutorial, so we can reproduce by running <code>git checkout</code> and <code>docker compose up --build --force-recreate</code>, and we will get the similar result as shown in this tutorial.</p><h1 id=using-opentelemetry-to-trace-user-journey>Using OpenTelemetry to Trace User Journey
<a class=anchor href=#using-opentelemetry-to-trace-user-journey>#</a></h1><p>OpenTelemetry came as a set of standard to make developer (and also ops) easier to see the application traces, metrics and logs by instrumenting the code. But, when this tutorial is written,
<a href=https://github.com/open-telemetry/opentelemetry-ruby/tree/opentelemetry-sdk/v1.2.0>the OpenTelemetry SDK for Ruby version 1.2.0</a> (with commit id
<a href=https://github.com/open-telemetry/opentelemetry-ruby/releases/tag/opentelemetry-sdk%2Fv1.2.0>ad7c3b9c4fcdf2f74705a9ac08310b7067e97162</a>)
<a href=https://github.com/open-telemetry/opentelemetry.io/blob/7f1501407b9643b4f517a189b3544ad08ec6ca07/data/instrumentation.yaml#L44-L49>not supports</a>
<a href=https://github.com/open-telemetry/opentelemetry.io/blob/7f1501407b9643b4f517a189b3544ad08ec6ca07/content/en/docs/instrumentation/ruby/_index.md>OpenTelemetry Metric and Logging</a>.</p><p><img src=/blog/post-assets/2023-02-24/opentelemetry-ruby-sdk-page.png alt="Figure 2. OpenTelemetry Ruby SDK Page"></p><div style=text-align:center;margin-bottom:30px>Figure 2. OpenTelemetry Ruby SDK Page</div><p>So, as the workaround to make standard logging that can be linked to the trace, we need to implement the
<a href=https://github.com/open-telemetry/oteps/pull/114>OTEP0114</a> which add these property in our existing log output:</p><ul><li>&ldquo;trace_id&rdquo; hex-encoded.</li><li>&ldquo;span_id&rdquo; hex-encoded.</li><li>&ldquo;trace_flags&rdquo; formatted according to W3C <code>traceflags</code> format.</li></ul><blockquote><p>References:</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-specification/blob/v1.18.0/specification/logs/README.md?plain=1#L474-L526">https://github.com/open-telemetry/opentelemetry-specification/blob/v1.18.0/specification/logs/README.md?plain=1#L474-L526</a></li><li><a href=https://github.com/open-telemetry/oteps/pull/114>https://github.com/open-telemetry/oteps/pull/114</a></li></ul></blockquote><h1 id=using-json-as-the-log-format-output>Using JSON as the Log Format Output
<a class=anchor href=#using-json-as-the-log-format-output>#</a></h1><p>In the OpenTelemetry page discussing
<a href="https://github.com/open-telemetry/opentelemetry-specification/blob/v1.18.0/specification/logs/README.md?plain=1#L474-L526">Trace Context in Legacy Formats</a>, there no advice to use JSON format over the
<a href=https://www.rfc-editor.org/rfc/rfc5424>Syslog RFC5424</a> or other format. But in my opinion, using JSON as the log format output will make debugging more easier because it can be stored into NoSQL database and then query it. In result, by able to query the logs, we can group the logs based on <code>trace_id</code> which means that all logs with the same <code>trace_id</code> are produced by the one request journey from the client.</p><p><img src=/blog/post-assets/2023-02-24/opentelemetry-trace-context-in-legacy-format.png alt="Figure 3. Trace Context in Legacy Formats"></p><div style=text-align:center;margin-bottom:30px>Figure 3. Trace Context in Legacy Formats</div><h1 id=part-1-preparing-the-ruby-on-rails-application>Part 1: Preparing the Ruby on Rails Application
<a class=anchor href=#part-1-preparing-the-ruby-on-rails-application>#</a></h1><p>If you are new to the Ruby on Rails, you can follow this
<a href=/posts/2023-02-24-rails-otel-part1/>part 1</a>. Otherwise, go to
<a href=/posts/2023-02-24-rails-otel-part2/>Part 2.</a></p><h1 id=part-2-improving-log-output>Part 2: Improving Log Output
<a class=anchor href=#part-2-improving-log-output>#</a></h1><p>Go to this link for the
<a href=/posts/2023-02-24-rails-otel-part2/>Part 2.</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/yusufsyaifudin/blog/commit/1af3d1d4da5c17cf74a1d39d43ac16dcef5fb2f0 title='Last modified by Yusuf Syaifudin | December 27, 2023' target=_blank rel=noopener><img src=/blog/svg/calendar.svg class=book-icon alt=Calendar>
<span>December 27, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/yusufsyaifudin/blog/edit/main/content/posts/2023-02-24-rails-otel-intro.md target=_blank rel=noopener><img src=/blog/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#the-problem>The Problem</a></li><li><a href=#using-opentelemetry-to-trace-user-journey>Using OpenTelemetry to Trace User Journey</a></li><li><a href=#using-json-as-the-log-format-output>Using JSON as the Log Format Output</a></li><li><a href=#part-1-preparing-the-ruby-on-rails-application>Part 1: Preparing the Ruby on Rails Application</a></li><li><a href=#part-2-improving-log-output>Part 2: Improving Log Output</a></li></ul></nav></div></aside></main></body></html>