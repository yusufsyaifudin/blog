<!doctype html><html lang=en dir=ltr><head><meta name=generator content="Hugo 0.121.1"><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In previous part you already know how to setup a simple (really simple) Rails application with one route. In this part, I will focusing on how we improve the log printed by the standard Rails application.
To recap, if you want to follow this article smoothly, you can use the code from previous part by cloning from my Github repository:
git clone https://github.com/yusufsyaifudin/rails-otel.git And then checkout to the commit id c85c199 where is the last state of the code from previous article."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID (Part 2 - Improving Log Output)"><meta property="og:description" content="In previous part you already know how to setup a simple (really simple) Rails application with one route. In this part, I will focusing on how we improve the log printed by the standard Rails application.
To recap, if you want to follow this article smoothly, you can use the code from previous part by cloning from my Github repository:
git clone https://github.com/yusufsyaifudin/rails-otel.git And then checkout to the commit id c85c199 where is the last state of the code from previous article."><meta property="og:type" content="article"><meta property="og:url" content="https://yusufsyaifudin.github.io/blog/posts/2023-02-24-rails-otel-part2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-24T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-27T08:25:25+07:00"><title>Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID (Part 2 - Improving Log Output) | yusuf's blog</title>
<link rel=manifest href=/blog/manifest.json><link rel=icon href=/blog/favicon.png type=image/x-icon><link rel=stylesheet href=/blog/book.min.68be0b7a9674f2a612ce0e9b2e9447ff4b7ac96546e06b642bfd3ded0ca490ef.css integrity="sha256-aL4LepZ08qYSzg6bLpRH/0t6yWVG4GtkK/097QykkO8="><script defer src=/blog/en.search.min.e7fa058893811212add3ba5904d8fc50bcfeb5a871faa0e25e208271807b8599.js integrity="sha256-5/oFiJOBEhKt07pZBNj8ULz+tahx+qDiXiCCcYB7hZk="></script><script defer src=/blog/sw.min.e30dcfc647efc866455c67b26b2aabda17816f06fe2dd202ac21b4422180bd9b.js integrity="sha256-4w3PxkfvyGZFXGeyayqr2heBbwb+LdICrCG0QiGAvZs="></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/blog><span>yusuf's blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/blog/posts/>Blog</a></li><li><a href=https://github.com/yusufsyaifudin target=_blank rel=noopener>My Github</a></li><li><a href=https://github.com/alex-shpak/hugo-book target=_blank rel=noopener>Hugo Theme</a></li></ul></nav><script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/blog/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID (Part 2 - Improving Log Output)</strong>
<label for=toc-control><img src=/blog/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#give-traffics-to-rails-application>Give Traffics to Rails Application</a><ul><li><a href=#preparing-the-data>Preparing the data</a></li><li><a href=#generate-traffic-using-k6-load-testing>Generate Traffic Using <code>k6</code> Load Testing</a></li></ul></li><li><a href=#breaking-down-the-problem>Breaking down the problem</a><ul><li><a href=#complexity-and-volume>Complexity and Volume</a></li><li><a href=#lack-of-structure>Lack of structure</a></li><li><a href=#lack-of-context>Lack of context</a></li><li><a href=#lack-of-tooling>Lack of tooling</a></li></ul></li><li><a href=#refactoring-log-output-to-structured-log>Refactoring Log Output To Structured Log</a><ul><li><a href=#change-the-booting-output>Change the Booting Output</a></li><li><a href=#add-opentelemetry-sdk>Add OpenTelemetry SDK</a></li><li><a href=#duck-typing-the-rubylogger>Duck-typing the Ruby::Logger</a></li><li><a href=#duck-typing-the-ruby-activerecord-logger>Duck-typing the Ruby ActiveRecord Logger</a></li><li><a href=#creating-opentelemetry-middleware>Creating OpenTelemetry Middleware</a></li><li><a href=#using-custom-logger-function>Using Custom Logger Function</a></li><li><a href=#bonus-add-trace-using-opentelemetry>Bonus: Add Trace using OpenTelemetry</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside></header><article class=markdown><h1><a href=/blog/posts/2023-02-24-rails-otel-part2/>Better Observability on Ruby on Rails Logs with OpenTelemetry Trace and Span ID (Part 2 - Improving Log Output)</a></h1><h5>February 24, 2023</h5><div><a href=/blog/categories/tutorials/>tutorials</a></div><div><a href=/blog/tags/ruby/>ruby</a>,
<a href=/blog/tags/rails/>rails</a>,
<a href=/blog/tags/opentelemetry/>opentelemetry</a></div><p>In
<a href=/posts/2023-02-24-rails-otel-part1/>previous part</a> you already know how to setup a simple (really simple) Rails application with one route. In this part, I will focusing on how we improve the log printed by the standard Rails application.</p><p>To recap, if you want to follow this article smoothly, you can use the code from previous part by cloning from my Github repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/yusufsyaifudin/rails-otel.git
</span></span></code></pre></div><p>And then checkout to the commit id
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/c85c199c3a46ddb0a245f4ccd340bf5850fa17dd?diff=split">c85c199</a> where is the last state of the code from previous article.:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git checkout c85c199c3a46ddb0a245f4ccd340bf5850fa17dd
</span></span></code></pre></div><p>As we already saw in the introduction article, when we&rsquo;re running the Rails application, at default it will print the log output that look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>myapp  | Started GET <span style=color:#e6db74>&#34;/list-vouchers&#34;</span> <span style=color:#66d9ef>for</span> 192.168.32.1 at 2023-03-09 03:26:00 +0000
</span></span><span style=display:flex><span>myapp  | Cannot render console from 192.168.32.1! Allowed networks: 127.0.0.0/127.255.255.255, ::1
</span></span><span style=display:flex><span>myapp  |   ActiveRecord::SchemaMigration Pluck <span style=color:#f92672>(</span>1.8ms<span style=color:#f92672>)</span>  SELECT <span style=color:#e6db74>&#34;schema_migrations&#34;</span>.<span style=color:#e6db74>&#34;version&#34;</span> FROM <span style=color:#e6db74>&#34;schema_migrations&#34;</span> ORDER BY <span style=color:#e6db74>&#34;schema_migrations&#34;</span>.<span style=color:#e6db74>&#34;version&#34;</span> ASC
</span></span><span style=display:flex><span>myapp  | Processing by UserPromotionController#list_vouchers as HTML
</span></span><span style=display:flex><span>myapp  | request accepted by controller
</span></span><span style=display:flex><span>myapp  | accepting token from headers
</span></span><span style=display:flex><span>myapp  | validating JWT
</span></span><span style=display:flex><span>myapp  | reaching business logic
</span></span><span style=display:flex><span>myapp  | doing query get user by id c8c6991c-687e-44cc-8755-4743ef66d265
</span></span><span style=display:flex><span>myapp  |   User Load <span style=color:#f92672>(</span>2.2ms<span style=color:#f92672>)</span>  SELECT <span style=color:#e6db74>&#34;users&#34;</span>.* FROM <span style=color:#e6db74>&#34;users&#34;</span> WHERE <span style=color:#e6db74>&#34;users&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> $1 LIMIT $2  <span style=color:#f92672>[[</span><span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span><span style=color:#f92672>]</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;LIMIT&#34;</span>, 1<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>myapp  |   ↳ app/services/vouchers/user_voucher.rb:7:in <span style=color:#e6db74>`</span>vouchers<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>myapp  | calling PromotionService.list_vouchers from UserVoucher.list_vouchers c8c6991c-687e-44cc-8755-4743ef66d265
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers call started
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>myapp  | controller <span style=color:#66d9ef>done</span> processing the request, preparing rendering response
</span></span><span style=display:flex><span>myapp  | Completed <span style=color:#ae81ff>200</span> OK in 314ms <span style=color:#f92672>(</span>Views: 12.1ms | ActiveRecord: 9.0ms | Allocations: 8720<span style=color:#f92672>)</span>
</span></span></code></pre></div><h1 id=give-traffics-to-rails-application>Give Traffics to Rails Application
<a class=anchor href=#give-traffics-to-rails-application>#</a></h1><p>Before we breaking down the problems that we may have in default Rails app, we need to make sure we have enough traffic to mock the high traffic that we may face in production. To do that, we need more than 1 users and concurrent access to our routes.</p><h2 id=preparing-the-data>Preparing the data
<a class=anchor href=#preparing-the-data>#</a></h2><p>First, let us create 100 users, using <code>rails console</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose run --no-deps myapp rails console
</span></span></code></pre></div><blockquote><p><strong>Note:</strong></p><p>Before you run this command, you need to make sure that the Rails application is active by running <code>docker compose up --build --force-recreate</code> in separate terminal.</p></blockquote><p>Then, inside <code>rails console</code> run this command to insert 100 users at once:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>for</span> counter <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>..</span><span style=color:#ae81ff>100</span> <span style=color:#66d9ef>do</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>::</span>create(<span style=color:#e6db74>username</span>: <span style=color:#e6db74>&#34;user</span><span style=color:#e6db74>#{</span>counter<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, name: <span style=color:#e6db74>&#34;User </span><span style=color:#e6db74>#{</span>counter<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>) <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Above command will insert 100 user. Now, let&rsquo;s create a JSON Web Token (JWT) on each user:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require_dependency <span style=color:#e6db74>&#34;json_web_token&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tokens <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> counter <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>..</span><span style=color:#ae81ff>100</span> <span style=color:#66d9ef>do</span> 
</span></span><span style=display:flex><span>  username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;user</span><span style=color:#e6db74>#{</span>counter<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  token <span style=color:#f92672>=</span> <span style=color:#66d9ef>JsonWebToken</span><span style=color:#f92672>.</span>encode({ <span style=color:#e6db74>user_id</span>: <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>find_by(<span style=color:#e6db74>username</span>: username)<span style=color:#f92672>.</span>id })
</span></span><span style=display:flex><span>  tokens<span style=color:#f92672>.</span>push({<span style=color:#e6db74>username</span>: username, <span style=color:#e6db74>token</span>: token})
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Dir</span><span style=color:#f92672>.</span>mkdir(<span style=color:#e6db74>&#34;scripts&#34;</span>) <span style=color:#66d9ef>unless</span> <span style=color:#66d9ef>Dir</span><span style=color:#f92672>.</span>exist?(<span style=color:#e6db74>&#34;scripts&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>Dir</span><span style=color:#f92672>.</span>mkdir(<span style=color:#e6db74>&#34;scripts/loadtest&#34;</span>) <span style=color:#66d9ef>unless</span> <span style=color:#66d9ef>Dir</span><span style=color:#f92672>.</span>exist?(<span style=color:#e6db74>&#34;scripts/loadtest&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>open(<span style=color:#e6db74>&#34;scripts/loadtest/tokens.json&#34;</span>, <span style=color:#e6db74>&#39;w&#39;</span>) {<span style=color:#f92672>|</span>f<span style=color:#f92672>|</span> f<span style=color:#f92672>.</span>write(tokens<span style=color:#f92672>.</span>to_json) }
</span></span></code></pre></div><p>This will create a file <code>scripts/k6/tokens.json</code> which contain a list of token and username in JSON array (in minified version) as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;user1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;token&#34;</span>: <span style=color:#e6db74>&#34;eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiNmI4NzUyMWEtMTJhOC00MGUxLTkxZDEtYTU3YzAxZDM5N2YwIn0.Zpw7sm-SCW6lROcfU0CB3oOe1Fjsg5REDKCnNTfHkAk&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><h2 id=generate-traffic-using-k6-load-testing>Generate Traffic Using <code>k6</code> Load Testing
<a class=anchor href=#generate-traffic-using-k6-load-testing>#</a></h2><p>First, we need to install <code>k6</code> by following this instruction
<a href=https://k6.io/docs/get-started/installation/>https://k6.io/docs/get-started/installation/</a> or using Docker.</p><p>Then, create a file <code>scripts/loadtest/list-vouchers.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>check</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;k6&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Counter</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;k6/metrics&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>http</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;k6/http&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>uuidv4</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;https://jslib.k6.io/k6-utils/1.4.0/index.js&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>successCounter</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Counter</span>(<span style=color:#e6db74>&#39;success_counter&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>failedCounter</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Counter</span>(<span style=color:#e6db74>&#39;failed_counter&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>payloads</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#39;/scripts/loadtest/tokens.json&#39;</span>));
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>randomIndex</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> <span style=color:#a6e22e>payloads</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>payload</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>payloads</span>[<span style=color:#a6e22e>randomIndex</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;X-Request-ID&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>uuidv4</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>token</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>serviceURL</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>__ENV</span>.<span style=color:#a6e22e>SERVICE_URL</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>serviceURL</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/list-vouchers&#39;</span>, <span style=color:#a6e22e>params</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>check</span>(<span style=color:#a6e22e>resp</span>, {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;status is 200&#39;</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>r</span>) =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;response contains expected username&#39;</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>r</span>) =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>json</span>().<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span><span style=color:#f92672>===</span> <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>200</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>successCounter</span>.<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>failedCounter</span>.<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>check</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;k6&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Counter</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;k6/metrics&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>http</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;k6/http&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>uuidv4</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;https://jslib.k6.io/k6-utils/1.4.0/index.js&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>successCounter</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Counter</span>(<span style=color:#e6db74>&#39;success_counter&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>failedCounter</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Counter</span>(<span style=color:#e6db74>&#39;failed_counter&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>payloads</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#39;/scripts/loadtest/tokens.json&#39;</span>));
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>randomIndex</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> <span style=color:#a6e22e>payloads</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>payload</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>payloads</span>[<span style=color:#a6e22e>randomIndex</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;X-Request-ID&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>uuidv4</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>token</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>serviceURL</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>__ENV</span>.<span style=color:#a6e22e>SERVICE_URL</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>serviceURL</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/list-vouchers&#39;</span>, <span style=color:#a6e22e>params</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>check</span>(<span style=color:#a6e22e>resp</span>, {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;contains expected username&#39;</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>r</span>) =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>200</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>json</span>().<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span><span style=color:#f92672>===</span> <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>200</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>successCounter</span>.<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>failedCounter</span>.<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, run this command to do only one request using K6 Docker:</p><blockquote><p>Don&rsquo;t forget to use <code>--net=host</code> to make sure Docker access &ldquo;localhost&rdquo; to your Host machine</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat scripts/loadtest/list-vouchers.js | docker run <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> -e SERVICE_URL<span style=color:#f92672>=</span>http://localhost:3000 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/scripts/loadtest/tokens.json:/scripts/loadtest/tokens.json:ro <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> --net<span style=color:#f92672>=</span>host --platform linux/amd64 --rm -i grafana/k6:0.43.1 run -
</span></span></code></pre></div><p>If it runs with no issues, you will look the result like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>SERVICE_URL<span style=color:#f92672>=</span>http://localhost:3000 AUTH_TOKEN<span style=color:#f92672>=</span>eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYzhjNjk5MWMtNjg3ZS00NGNjLTg3NTUtNDc0M2VmNjZkMjY1In0.TCrEUFziQY4800jAT9ioY2mOm_b9eLdC20gtXjdTt14 k6 run scripts/loadtest/list-vouchers.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          /<span style=color:#ae81ff>\ </span>     |‾‾| /‾‾/   /‾‾/
</span></span><span style=display:flex><span>     /<span style=color:#ae81ff>\ </span> /  <span style=color:#ae81ff>\ </span>    |  |/  /   /  /
</span></span><span style=display:flex><span>    /  <span style=color:#ae81ff>\/</span>    <span style=color:#ae81ff>\ </span>   |     <span style=color:#f92672>(</span>   /   ‾‾<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   /          <span style=color:#ae81ff>\ </span>  |  |<span style=color:#ae81ff>\ </span> <span style=color:#ae81ff>\ </span>|  <span style=color:#f92672>(</span>‾<span style=color:#f92672>)</span>  |
</span></span><span style=display:flex><span>  / __________ <span style=color:#ae81ff>\ </span> |__| <span style=color:#ae81ff>\_</span>_<span style=color:#ae81ff>\ \_</span>____/ .io
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  execution: local
</span></span><span style=display:flex><span>     script: scripts/loadtest/list-vouchers.js
</span></span><span style=display:flex><span>     output: -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  scenarios: <span style=color:#f92672>(</span>100.00%<span style=color:#f92672>)</span> <span style=color:#ae81ff>1</span> scenario, <span style=color:#ae81ff>1</span> max VUs, 10m30s max duration <span style=color:#f92672>(</span>incl. graceful stop<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>           * default: <span style=color:#ae81ff>1</span> iterations <span style=color:#66d9ef>for</span> each of <span style=color:#ae81ff>1</span> VUs <span style=color:#f92672>(</span>maxDuration: 10m0s, gracefulStop: 30s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     data_received..................: 1.4 kB 1.5 kB/s
</span></span><span style=display:flex><span>     data_sent......................: <span style=color:#ae81ff>242</span> B  <span style=color:#ae81ff>265</span> B/s
</span></span><span style=display:flex><span>     http_req_blocked...............: avg<span style=color:#f92672>=</span>30.69ms  min<span style=color:#f92672>=</span>30.69ms  med<span style=color:#f92672>=</span>30.69ms  max<span style=color:#f92672>=</span>30.69ms  p<span style=color:#f92672>(</span>90<span style=color:#f92672>)=</span>30.69ms  p<span style=color:#f92672>(</span>95<span style=color:#f92672>)=</span>30.69ms
</span></span><span style=display:flex><span>     http_req_connecting............: avg<span style=color:#f92672>=</span>146µs    min<span style=color:#f92672>=</span>146µs    med<span style=color:#f92672>=</span>146µs    max<span style=color:#f92672>=</span>146µs    p<span style=color:#f92672>(</span>90<span style=color:#f92672>)=</span>146µs    p<span style=color:#f92672>(</span>95<span style=color:#f92672>)=</span>146µs
</span></span><span style=display:flex><span>     http_req_duration..............: avg<span style=color:#f92672>=</span>877.07ms min<span style=color:#f92672>=</span>877.07ms med<span style=color:#f92672>=</span>877.07ms max<span style=color:#f92672>=</span>877.07ms p<span style=color:#f92672>(</span>90<span style=color:#f92672>)=</span>877.07ms p<span style=color:#f92672>(</span>95<span style=color:#f92672>)=</span>877.07ms
</span></span><span style=display:flex><span>       <span style=color:#f92672>{</span> expected_response:true <span style=color:#f92672>}</span>...: avg<span style=color:#f92672>=</span>877.07ms min<span style=color:#f92672>=</span>877.07ms med<span style=color:#f92672>=</span>877.07ms max<span style=color:#f92672>=</span>877.07ms p<span style=color:#f92672>(</span>90<span style=color:#f92672>)=</span>877.07ms p<span style=color:#f92672>(</span>95<span style=color:#f92672>)=</span>877.07ms
</span></span><span style=display:flex><span>     http_req_failed................: 0.00%  ✓ <span style=color:#ae81ff>0</span>        ✗ <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>     http_req_receiving.............: avg<span style=color:#f92672>=</span>626µs    min<span style=color:#f92672>=</span>626µs    med<span style=color:#f92672>=</span>626µs    max<span style=color:#f92672>=</span>626µs    p<span style=color:#f92672>(</span>90<span style=color:#f92672>)=</span>626µs    p<span style=color:#f92672>(</span>95<span style=color:#f92672>)=</span>626µs
</span></span><span style=display:flex><span>     http_req_sending...............: avg<span style=color:#f92672>=</span>491µs    min<span style=color:#f92672>=</span>491µs    med<span style=color:#f92672>=</span>491µs    max<span style=color:#f92672>=</span>491µs    p<span style=color:#f92672>(</span>90<span style=color:#f92672>)=</span>491µs    p<span style=color:#f92672>(</span>95<span style=color:#f92672>)=</span>491µs
</span></span><span style=display:flex><span>     http_req_tls_handshaking.......: avg<span style=color:#f92672>=</span>0s       min<span style=color:#f92672>=</span>0s       med<span style=color:#f92672>=</span>0s       max<span style=color:#f92672>=</span>0s       p<span style=color:#f92672>(</span>90<span style=color:#f92672>)=</span>0s       p<span style=color:#f92672>(</span>95<span style=color:#f92672>)=</span>0s
</span></span><span style=display:flex><span>     http_req_waiting...............: avg<span style=color:#f92672>=</span>875.95ms min<span style=color:#f92672>=</span>875.95ms med<span style=color:#f92672>=</span>875.95ms max<span style=color:#f92672>=</span>875.95ms p<span style=color:#f92672>(</span>90<span style=color:#f92672>)=</span>875.95ms p<span style=color:#f92672>(</span>95<span style=color:#f92672>)=</span>875.95ms
</span></span><span style=display:flex><span>     http_reqs......................: <span style=color:#ae81ff>1</span>      1.095911/s
</span></span><span style=display:flex><span>     iteration_duration.............: avg<span style=color:#f92672>=</span>912.13ms min<span style=color:#f92672>=</span>912.13ms med<span style=color:#f92672>=</span>912.13ms max<span style=color:#f92672>=</span>912.13ms p<span style=color:#f92672>(</span>90<span style=color:#f92672>)=</span>912.13ms p<span style=color:#f92672>(</span>95<span style=color:#f92672>)=</span>912.13ms
</span></span><span style=display:flex><span>     iterations.....................: <span style=color:#ae81ff>1</span>      1.095911/s
</span></span><span style=display:flex><span>     success_counter................: <span style=color:#ae81ff>1</span>      1.095911/s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>running <span style=color:#f92672>(</span>00m00.9s<span style=color:#f92672>)</span>, 0/1 VUs, <span style=color:#ae81ff>1</span> complete and <span style=color:#ae81ff>0</span> interrupted iterations
</span></span><span style=display:flex><span>default ✓ <span style=color:#f92672>[======================================]</span> <span style=color:#ae81ff>1</span> VUs  00m00.9s/10m0s  1/1 iters, <span style=color:#ae81ff>1</span> per VU
</span></span></code></pre></div><p><img src=/blog/post-assets/2023-02-24/k6-run-once-request.png alt="Figure 1. Run Simple K6 Command"></p><div style=text-align:center;margin-bottom:30px>Figure 1. Run Simple K6 Command</div><p>And the Rails log output will look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>myapp  | Started GET <span style=color:#e6db74>&#34;/list-vouchers&#34;</span> <span style=color:#66d9ef>for</span> 192.168.32.1 at 2023-03-09 03:26:00 +0000
</span></span><span style=display:flex><span>myapp  | Cannot render console from 192.168.32.1! Allowed networks: 127.0.0.0/127.255.255.255, ::1
</span></span><span style=display:flex><span>myapp  |   ActiveRecord::SchemaMigration Pluck <span style=color:#f92672>(</span>1.8ms<span style=color:#f92672>)</span>  SELECT <span style=color:#e6db74>&#34;schema_migrations&#34;</span>.<span style=color:#e6db74>&#34;version&#34;</span> FROM <span style=color:#e6db74>&#34;schema_migrations&#34;</span> ORDER BY <span style=color:#e6db74>&#34;schema_migrations&#34;</span>.<span style=color:#e6db74>&#34;version&#34;</span> ASC
</span></span><span style=display:flex><span>myapp  | Processing by UserPromotionController#list_vouchers as HTML
</span></span><span style=display:flex><span>myapp  | request accepted by controller
</span></span><span style=display:flex><span>myapp  | accepting token from headers
</span></span><span style=display:flex><span>myapp  | validating JWT
</span></span><span style=display:flex><span>myapp  | reaching business logic
</span></span><span style=display:flex><span>myapp  | doing query get user by id c8c6991c-687e-44cc-8755-4743ef66d265
</span></span><span style=display:flex><span>myapp  |   User Load <span style=color:#f92672>(</span>2.2ms<span style=color:#f92672>)</span>  SELECT <span style=color:#e6db74>&#34;users&#34;</span>.* FROM <span style=color:#e6db74>&#34;users&#34;</span> WHERE <span style=color:#e6db74>&#34;users&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> $1 LIMIT $2  <span style=color:#f92672>[[</span><span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span><span style=color:#f92672>]</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;LIMIT&#34;</span>, 1<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>myapp  |   ↳ app/services/vouchers/user_voucher.rb:7:in <span style=color:#e6db74>`</span>vouchers<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>myapp  | calling PromotionService.list_vouchers from UserVoucher.list_vouchers c8c6991c-687e-44cc-8755-4743ef66d265
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers call started
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>myapp  | controller <span style=color:#66d9ef>done</span> processing the request, preparing rendering response
</span></span><span style=display:flex><span>myapp  | Completed <span style=color:#ae81ff>200</span> OK in 314ms <span style=color:#f92672>(</span>Views: 12.1ms | ActiveRecord: 9.0ms | Allocations: 8720<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  |
</span></span></code></pre></div><p><img src=/blog/post-assets/2023-02-24/rails-app-log-one-request.png alt="Figure 2. Rails Logging Output With One Request"></p><div style=text-align:center;margin-bottom:30px>Figure 2. Rails Logging Output With One Request</div><p>At this point, we already have a working Rails app that show the default log output format. In the next section, I will show you what we can improve with the log output.</p><p><strong>You can see changes in this section (adding <code>k6</code> load testing script) here:
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/3548129e4681c36268617025e04f5dbc1a0748e5?diff=split">3548129</a></strong></p><h1 id=breaking-down-the-problem>Breaking down the problem
<a class=anchor href=#breaking-down-the-problem>#</a></h1><p>In the
<a href=/posts/2023-02-24-rails-otel-intro/>Introduction</a> I quoted the ChatGPT responses on &ldquo;why rails app log hard to debug&rdquo;.</p><p>In this section, I will give some proof of the statements.</p><p>From the previous section, lets we do more request using <code>k6</code> with 10 VUs (Virtual Users) for 10 seconds:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat scripts/loadtest/list-vouchers.js | docker run <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> -e SERVICE_URL<span style=color:#f92672>=</span>http://localhost:3000 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/scripts/loadtest/tokens.json:/scripts/loadtest/tokens.json:ro <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> --net<span style=color:#f92672>=</span>host --platform linux/amd64 --rm -i grafana/k6:0.43.1 run --vus <span style=color:#ae81ff>10</span> --duration 10s -
</span></span></code></pre></div><p>As we can see in Figure 3, we already give our Rails app with 164 requests (you can see in the <code>iterations</code> in the Figure 3).
This number may different each time you run the <code>k6</code> load testing, it depends on multi-factor.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>iterations.....................: <span style=color:#ae81ff>164</span>     14.951436/s
</span></span></code></pre></div><p><img src=/blog/post-assets/2023-02-24/k6-run-100vus.png alt="Figure 3. K6 Output With 100VUs for 10s"></p><div style=text-align:center;margin-bottom:30px>Figure 3. K6 Output With 100VUs for 10s</div><p>In Figure 4 below, we can see that the Rails logger now is harder to read.</p><p><img src=/blog/post-assets/2023-02-24/rails-logs-become-hard-to-read.png alt="Figure 4. Rails Log Output Become Hard To Read"></p><div style=text-align:center;margin-bottom:30px>Figure 4. Rails Log Output Become Hard To Read</div><details><summary>Rails Log Output Become Hard To Read</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>myapp  | Processing by UserPromotionController#list_vouchers as HTML
</span></span><span style=display:flex><span>myapp  | request accepted by controller
</span></span><span style=display:flex><span>myapp  | accepting token from headers
</span></span><span style=display:flex><span>myapp  | validating JWT
</span></span><span style=display:flex><span>myapp  | reaching business logic
</span></span><span style=display:flex><span>myapp  | doing query get user by id dd2865e6-4529-44c3-b475-f3cfa3eb6551
</span></span><span style=display:flex><span>myapp  |   User Load <span style=color:#f92672>(</span>0.2ms<span style=color:#f92672>)</span>  SELECT <span style=color:#e6db74>&#34;users&#34;</span>.* FROM <span style=color:#e6db74>&#34;users&#34;</span> WHERE <span style=color:#e6db74>&#34;users&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> $1 LIMIT $2  <span style=color:#f92672>[[</span><span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;dd2865e6-4529-44c3-b475-f3cfa3eb6551&#34;</span><span style=color:#f92672>]</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;LIMIT&#34;</span>, 1<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>myapp  |   ↳ app/services/vouchers/user_voucher.rb:7:in <span style=color:#e6db74>`</span>vouchers<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | calling PromotionService.list_vouchers from UserVoucher.list_vouchers dd2865e6-4529-44c3-b475-f3cfa3eb6551
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | PromotionService.list_vouchers call started
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | PromotionService.list_vouchers done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | controller done processing the request, preparing rendering response
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | Completed 200 OK in 152ms (Views: 0.6ms | ActiveRecord: 0.7ms | Allocations: 5057)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | PromotionService.list_vouchers done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | controller done processing the request, preparing rendering response
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | Completed 200 OK in 139ms (Views: 0.4ms | ActiveRecord: 0.2ms | Allocations: 1649)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | Started GET &#34;/list-vouchers&#34; for 192.168.80.1 at 2023-03-09 09:32:28 +0000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | Cannot render console from 192.168.80.1! Allowed networks: 127.0.0.0/127.255.255.255, ::1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | Processing by UserPromotionController#list_vouchers as HTML
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | request accepted by controller
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | accepting token from headers
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | validating JWT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | reaching business logic
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  | doing query get user by id 99dca0af-84f2-4e9f-9925-66a5b6442c2a
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  |   User Load (0.3ms)  SELECT &#34;users&#34;.* FROM &#34;users&#34; WHERE &#34;users&#34;.&#34;id&#34; = $1 LIMIT $2  [[&#34;id&#34;, &#34;99dca0af-84f2-4e9f-9925-66a5b6442c2a&#34;], [&#34;LIMIT&#34;, 1]]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>myapp  |   ↳ app/services/vouchers/user_voucher.rb:7:in `vouchers&#39;</span>
</span></span><span style=display:flex><span>myapp  | calling PromotionService.list_vouchers from UserVoucher.list_vouchers 99dca0af-84f2-4e9f-9925-66a5b6442c2a
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers call started
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>myapp  | controller <span style=color:#66d9ef>done</span> processing the request, preparing rendering response
</span></span><span style=display:flex><span>myapp  | Completed <span style=color:#ae81ff>200</span> OK in 496ms <span style=color:#f92672>(</span>Views: 0.8ms | ActiveRecord: 0.4ms | Allocations: 11963<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>myapp  | controller <span style=color:#66d9ef>done</span> processing the request, preparing rendering response
</span></span><span style=display:flex><span>myapp  | Completed <span style=color:#ae81ff>200</span> OK in 371ms <span style=color:#f92672>(</span>Views: 0.7ms | ActiveRecord: 0.3ms | Allocations: 8049<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  | PromotionService.list_vouchers <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>myapp  | controller <span style=color:#66d9ef>done</span> processing the request, preparing rendering response
</span></span><span style=display:flex><span>myapp  | Completed <span style=color:#ae81ff>200</span> OK in 319ms <span style=color:#f92672>(</span>Views: 1.8ms | ActiveRecord: 0.3ms | Allocations: 2298<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  |
</span></span></code></pre></div></details><h2 id=complexity-and-volume>Complexity and Volume
<a class=anchor href=#complexity-and-volume>#</a></h2><blockquote><p>Rails applications can be complex with many layers of code that interact with each other. This can make it difficult to pinpoint the root cause of an issue.</p></blockquote><p>As you can see in Figure 4, when we have high traffic, the Rails log become hard to read because some log may delayed to print, so we cannot see the right order of the logs line. If we adding the timestamp at the front of each log lines, we still cannot get the better understanding because it is uncommon to sorting the unstructured logs. See also
<a href=/posts/2023-02-24-rails-otel-part2/#lack-of-context>#Lack of context</a>.</p><blockquote><p>Rails logs can generate a large volume of information, making it difficult to find the relevant information needed to debug an issue.</p></blockquote><p>Also, since the we have a large volumes of log, we need a good tooling which can be easier to query and filter to show log that we need to see.</p><h2 id=lack-of-structure>Lack of structure
<a class=anchor href=#lack-of-structure>#</a></h2><blockquote><p>Rails logs can lack structure, making it difficult to identify the relevant information needed to debug an issue.</p></blockquote><p>Structured log is easier to query and makes developer easier to pin-point the issues. For example, the Customer Service got the complaint from User U at time T that the application become unresponsive. The Customer Service then can open the ticket and let the developer to see the log only for that user at that time. If we still have unstructured log as shown in Figure 4, how we can do that?</p><p>If we have a structured log, (let say JSON formatted), we can pipe all these logs into Elasticsearch and query it using Kibana (or renowned as
<a href=https://www.elastic.co/what-is/elk-stack>ELK Stack</a>. As an alternative, we can use
<a href=https://grafana.com/docs/loki/latest/operations/storage/>Grafana Loki to query it from Cassandra or AWS DynamoDB</a>. JSON is preferred because developers should familiar with that kind of format as it commonly used in REST API request/response payload.</p><h2 id=lack-of-context>Lack of context
<a class=anchor href=#lack-of-context>#</a></h2><blockquote><p>Rails logs may not provide enough context to understand the flow of the application, making it difficult to understand how the different parts of the application are interacting.</p></blockquote><p>At Figure 4, we see <code>Completed 200 OK</code> three times at the end of the logs. But, how can we know the previous process that related to this line? Why at first we got 496ms, then 371ms and then 319ms? If at some point we see the number is more than 10 seconds, how can we know the related log that causing the process took too long?</p><h2 id=lack-of-tooling>Lack of tooling
<a class=anchor href=#lack-of-tooling>#</a></h2><blockquote><p>Traditional text editors or command line tools may not be well suited for analyzing logs, and dedicated log analysis tools can be expensive or require specialized knowledge.</p></blockquote><p>As I mention in
<a href=/posts/2023-02-24-rails-otel-part2/#lack-of-structure>#Lack of structure</a>, it is more easier to query using JSON that text. Even if we are only using terminal, with JSON we can do some query using
<a href=https://github.com/stedolan/jq><code>jq</code></a> or its alternative
<a href=https://github.com/itchyny/gojq><code>gojq</code></a>. But, I do prefer if we save it into some persistent storage (with some TTL to reduce cost of storage) and query them via dashboard UI (like Grafana Loki or Kibana).</p><h1 id=refactoring-log-output-to-structured-log>Refactoring Log Output To Structured Log
<a class=anchor href=#refactoring-log-output-to-structured-log>#</a></h1><p>After we acknowledge that there is a problem with our Rails app, we can then try to improve our log starting with making it as JSON output per log line.</p><p>We will refactor our log output to JSON, with this minimal structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;level&#34;</span>: <span style=color:#e6db74>&#34;INFO&#34;</span>, <span style=color:#75715e>// Required. Level of the log: 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;time&#34;</span>: <span style=color:#e6db74>&#34;2023-03-13T09:07:48.639Z&#34;</span>, <span style=color:#75715e>// Required. Time when the log is written in RFC3339 Nano https://www.rfc-editor.org/rfc/rfc3339
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;message of this log&#34;</span>, <span style=color:#75715e>// Required.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;trace_id&#34;</span>: <span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>, <span style=color:#75715e>// Required. hex-encoded.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;span_id&#34;</span>: <span style=color:#e6db74>&#34;0000000000000000&#34;</span>, <span style=color:#75715e>// Required. hex-encoded.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;trace_flags&#34;</span>: <span style=color:#e6db74>&#34;00&#34;</span>, <span style=color:#75715e>// Required. formatted according to W3C traceflags format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;node_id&#34;</span>: <span style=color:#e6db74>&#34;8689d48b-d323-4492-a989-b9fb7f7ad81a&#34;</span>, <span style=color:#75715e>// Required. UUID string that will always the same from start to stop. If restart, this ID MUST be generated again, so we can detect that two logs is come from different restart count.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;progname&#34;</span>: <span style=color:#e6db74>&#34;rails-otel&#34;</span>, <span style=color:#75715e>// Required. Service name that produce this log. This MUST contain lower-case and alphanumeric string only (dash or underscore is used as space replacement, no other character permitted).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;request_id&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#75715e>// Optional. Only appeared when the log is triggered via request-response model API (HTTP, gRPC, or anything)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;attributes&#34;</span>: [{<span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>}], <span style=color:#75715e>// Optional. Contains Array of object (key-value) format,,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;data&#34;</span>: {} <span style=color:#75715e>// Optional, can contain array or anything depend on the log you want to write.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=change-the-booting-output>Change the Booting Output
<a class=anchor href=#change-the-booting-output>#</a></h2><p>Since in booting process we cannot get any information regarding the</p><p>Add this line into file <code>config/boot.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;securerandom&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#34;rails/command&#34;</span> <span style=color:#75715e># Allow for base class autoload</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#34;rails/commands/server/server_command&#34;</span> <span style=color:#75715e># Load the ServerCommand class</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>RAILS_NODE_ID</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>SecureRandom</span><span style=color:#f92672>.</span>uuid
</span></span><span style=display:flex><span><span style=color:#66d9ef>PROGRAM_NAME</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;PROGRAM_NAME&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;no-service-name&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># https://stackoverflow.com/a/75651939</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Command</span><span style=color:#f92672>::</span><span style=color:#66d9ef>ServerCommand</span><span style=color:#f92672>.</span>class_eval <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># print_boot_information override the original method to make all log turn into JSON</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># https://github.com/rails/rails/blob/7c70791470fc517deb7c640bead9f1b47efb5539/railties/lib/rails/commands/server/server_command.rb#L278-L284</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 7c70791 is commit hash for release tag: https://github.com/rails/rails/releases/tag/v7.0.4.2</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># If you have different version of Rails, this method may not work!</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>print_boot_information</span>(server, url)
</span></span><span style=display:flex><span>    logs <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;Booting </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>ActiveSupport</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Inflector</span><span style=color:#f92672>.</span>demodulize(server)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;Rails </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>version<span style=color:#e6db74>}</span><span style=color:#e6db74> application starting in </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>env<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>#{</span>url<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;Run `bin/rails server --help` for more startup options&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ts <span style=color:#f92672>=</span> <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now
</span></span><span style=display:flex><span>    logs<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>log<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      json_log <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>level</span>: <span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>time</span>: ts,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>msg</span>: log,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>trace_id</span>: <span style=color:#e6db74>&#39;00000000000000000000000000000000&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>span_id</span>: <span style=color:#e6db74>&#39;0000000000000000&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>trace_flags</span>: <span style=color:#e6db74>&#39;00&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>node_id</span>: <span style=color:#66d9ef>RAILS_NODE_ID</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>progname</span>: <span style=color:#66d9ef>PROGRAM_NAME</span>,
</span></span><span style=display:flex><span>      }<span style=color:#f92672>.</span>to_json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(json_log)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Then, as we are using Puma as our server, we need to configure Puma log output into JSON by adding these line in the file <code>config/puma.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># Use JSON format for booting logs</span>
</span></span><span style=display:flex><span>ts <span style=color:#f92672>=</span> <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now
</span></span><span style=display:flex><span>log_formatter <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>str<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  line <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>level</span>: <span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>time</span>: ts,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>msg</span>: str<span style=color:#f92672>.</span>delete_prefix(<span style=color:#e6db74>&#39;*&#39;</span>)<span style=color:#f92672>.</span>chomp()<span style=color:#f92672>.</span>strip(),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>trace_id</span>: <span style=color:#e6db74>&#39;00000000000000000000000000000000&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>span_id</span>: <span style=color:#e6db74>&#39;0000000000000000&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>trace_flags</span>: <span style=color:#e6db74>&#39;00&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>node_id</span>: <span style=color:#66d9ef>RAILS_NODE_ID</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>progname</span>: <span style=color:#66d9ef>PROGRAM_NAME</span>,
</span></span><span style=display:flex><span>  }<span style=color:#f92672>.</span>to_json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(line)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>You may notice that we add global constant <code>PROGRAM_NAME</code> by getting its value from environment variable <code>ENV['PROGRAM_NAME']</code>, so we need to add the environment variable to <code>docker-compose.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>  16 environment:
</span></span><span style=display:flex><span>  17   DATABASE_USERNAME: root
</span></span><span style=display:flex><span>  18   DATABASE_PASSWORD: password
</span></span><span style=display:flex><span>  19   DATABASE_DB_NAME: rails_otel_dev
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ 20   PROGRAM_NAME: &#39;rails-otel&#39;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>  21
</span></span></code></pre></div><p>Now, restart the server by running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose up --build --force-recreate
</span></span></code></pre></div><p>Voilà, you&rsquo;ll see that now our log become structured JSON.</p><p><img src=/blog/post-assets/2023-02-24/rails-json-log-on-boot.png alt="Figure 5. Rails now produces JSON on booting"></p><div style=text-align:center;margin-bottom:30px>Figure 5. Rails now produces JSON on booting</div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.733+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Booting Puma&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.733+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Rails 7.0.4.2 application starting in development &#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.733+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Run `bin/rails server --help` for more startup options&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.983+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Puma starting in single mode...&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.983+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Puma version: 5.6.5 (ruby 3.2.1-p31) (\&#34;Birdie&#39;s Version\&#34;)&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.983+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Min threads: 5&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.983+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Max threads: 5&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.983+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Environment: development&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.983+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;PID: 1&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.983+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Listening on http://0.0.0.0:3000&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-03-13T09:47:13.983+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Use Ctrl-C to stop&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;5d5d3085-89f7-4374-bea7-a22445d5a770&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span></code></pre></div><p><strong>Changes on this section can be seen at this commit
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/21a46669fbf8377e58346f278ae842cb088d2c91?diff=split">21a4666</a>.</strong></p><h2 id=add-opentelemetry-sdk>Add OpenTelemetry SDK
<a class=anchor href=#add-opentelemetry-sdk>#</a></h2><p>Before configuring the rest of logger to JSON, we need to add OpenTelemetry to get the actual <code>trace_id</code> and <code>span_id</code>.
This is the advantages using OpenTelemetry SDK:</p><ul><li>We don&rsquo;t need to <strong>re-invent the wheel</strong> on how ID should be generated and formatted.</li><li>If we have enough budget, we can deploy Jaeger or Grafana or using provider such as DataDog or NewRelic to see our app trace.
Then we can also correlate logs and traces with the same <code>trace_id</code>.<ul><li>But, if we don&rsquo;t have enough resources (either human resource or infrastructure), we can disable OpenTelemetry to push and just use the SDK itself to generate.</li></ul></li></ul><p>First, we need to install OpenTelemetry Gem SDK:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a6e22e>+ 60 # A stats collection and distributed tracing framework
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 61 gem &#39;opentelemetry-sdk&#39;, &#39;1.2&#39;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 62
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 63 # OTLP exporter for the OpenTelemetry framework
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 64 gem &#39;opentelemetry-exporter-otlp&#39;, &#39;0.24.0&#39;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 65
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 66 # All-in-one instrumentation bundle for the OpenTelemetry framework
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 67 # Provides instrumentations for Rails, Sinatra, several HTTP libraries, and more.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 68 gem &#39;opentelemetry-instrumentation-all&#39;, &#39;0.31.0&#39;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 69 
</span></span></span></code></pre></div><p>Then, create a file <code>config/initializers/opentelemetry.rb</code> with following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;opentelemetry/sdk&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;opentelemetry/exporter/otlp&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;opentelemetry/instrumentation/all&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Custom exporter to make print to STDOUT</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyExporter</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exporter</span><span style=color:#f92672>::</span><span style=color:#66d9ef>OTLP</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exporter</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Override function here:</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># https://github.com/open-telemetry/opentelemetry-ruby/blob/opentelemetry-sdk/v1.2.0/exporter/otlp/lib/opentelemetry/exporter/otlp/exporter.rb#L79-L90</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>export</span>(span_data, <span style=color:#e6db74>timeout</span>: <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Custom logic for exporting data goes here</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(<span style=color:#e6db74>&#34;Exporting data: </span><span style=color:#e6db74>#{</span>span_data<span style=color:#f92672>.</span>inspect<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SDK</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Trace</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Export</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SUCCESS</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Exporter and Processor configuration</span>
</span></span><span style=display:flex><span><span style=color:#75715e># See list of arguments here https://github.com/open-telemetry/opentelemetry-ruby/blob/opentelemetry-sdk/v1.2.0/exporter/otlp/lib/opentelemetry/exporter/otlp/exporter.rb#L48-L54</span>
</span></span><span style=display:flex><span><span style=color:#75715e># As of March 15th, 2023, the gRPC exporter is not published to Rubygems and marked as not production ready.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># See https://github.com/open-telemetry/opentelemetry-ruby/issues/1337</span>
</span></span><span style=display:flex><span><span style=color:#75715e># So, we can only use HTTP for now.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>OTEL_EXPORTER</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exporter</span><span style=color:#f92672>::</span><span style=color:#66d9ef>OTLP</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exporter</span><span style=color:#f92672>.</span>new(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>endpoint</span>: <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;OTEL_EXPORTER_OTLP_ENDPOINT&#39;</span><span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Use this custom exporter if we want to log into STDOUT only, or implement another exporter (such as no-operation).</span>
</span></span><span style=display:flex><span><span style=color:#75715e># OTEL_EXPORTER = MyExporter.new()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># See https://github.com/open-telemetry/opentelemetry-ruby/blob/opentelemetry-sdk/v1.2.0/sdk/lib/opentelemetry/sdk/trace/export/batch_span_processor.rb#L47-L53</span>
</span></span><span style=display:flex><span>processor <span style=color:#f92672>=</span> <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SDK</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Trace</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Export</span><span style=color:#f92672>::</span><span style=color:#66d9ef>BatchSpanProcessor</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>OTEL_EXPORTER</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SDK</span><span style=color:#f92672>.</span>configure <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>c<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>resource <span style=color:#f92672>=</span> <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SDK</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Resources</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Resource</span><span style=color:#f92672>.</span>create({
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SemanticConventions</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Resource</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SERVICE_NAMESPACE</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;rails-app&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SemanticConventions</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Resource</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SERVICE_NAME</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>PROGRAM_NAME</span><span style=color:#f92672>.</span>to_s, <span style=color:#75715e># Global variable PROGRAM_NAME already defined in config/boot.rb</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SemanticConventions</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Resource</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SERVICE_INSTANCE_ID</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>Socket</span><span style=color:#f92672>.</span>gethostname(),
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SemanticConventions</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Resource</span><span style=color:#f92672>::</span><span style=color:#66d9ef>SERVICE_VERSION</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;0.0.0&#34;</span>, <span style=color:#75715e># we can get it from environment variable</span>
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># enables all instrumentation!</span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>use_all()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Or, if you prefer to filter specific instrumentation,</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># you can pick some of them like this https://scoutapm.com/blog/configuring-opentelemetry-in-ruby</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##### Instruments</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::Rack&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::ActionPack&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::ActionView&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::ActiveJob&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::ActiveRecord&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::ConcurrentRuby&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::Faraday&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::HttpClient&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::Net::HTTP&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::PG&#39;, {</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   # By default, this instrumentation includes the executed SQL as the `db.statement`</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   # semantic attribute. Optionally, you may disable the inclusion of this attribute entirely by</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   # setting this option to :omit or sanitize the attribute by setting to :obfuscate</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   db_statement: :obfuscate,</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># }</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::Rails&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::Redis&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::RestClient&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::RubyKafka&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># c.use &#39;OpenTelemetry::Instrumentation::Sidekiq&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Set OpenTelemetry library logger</span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>logger <span style=color:#f92672>=</span> <span style=color:#66d9ef>Logger</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>STDOUT</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Exporter and Processor configuration</span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>add_span_processor(processor)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;MyAppTracer&#39; can be used throughout your code now</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>MyAppTracer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>.</span>tracer_provider<span style=color:#f92672>.</span>tracer(<span style=color:#66d9ef>PROGRAM_NAME</span>, <span style=color:#e6db74>&#39;0.0.0&#39;</span>)
</span></span></code></pre></div><p>In above code, we are using HTTP to send the trace data to OpenTelemetry. But, if you wish to not send it, we can only print it (or entirely disable it) by using custom OpenTelemetry exporter <code>MyExporter</code> and change the exporter to <code>OTEL_EXPORTER = MyExporter.new()</code>.</p><p>Then, don&rsquo;t forget to shutdown the OpenTelemetry exporter during app shutdown.</p><p>In file <code>config/application.rb</code>, add this following line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a6e22e>+ 23
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 24    # Add a callback to shut down the OpenTelemetry exporter and SDK
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 25    config.after_initialize do
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 26      at_exit do
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 27        OTEL_EXPORTER.shutdown
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 28      end
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 29    end
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ 30
</span></span></span></code></pre></div><p>Now, we have OpenTelemetry SDK installed. Next, we need to use
<a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> as agent to receives the traces produced by our app and
<a href=https://www.jaegertracing.io/>Jaeger</a> as the dashboard. To do that, we can add this service in our <code>docker-compose.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>jaeger</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>jaegertracing/all-in-one:1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>jaeger</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;--collector.otlp.enabled=true&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;5775:5775/udp&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;6831:6831/udp&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;6832:6832/udp&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;5778:5778&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;16686:16686&#34;</span> <span style=color:#75715e># dashboard</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;14268:14268&#34;</span> <span style=color:#75715e># Accepts spans directly from clients in jaeger.thrift format with binary thrift protocol (POST to /api/traces). Also serves sampling policies at /api/sampling, similar to Agent’s port 5778.</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;9411:9411&#34;</span> <span style=color:#75715e># Accepts Zipkin spans in Thrift, JSON and Proto (disabled by default).</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;14269:14269&#34;</span> <span style=color:#75715e># Admin port: health check at / and metrics at /metrics.</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;14317:4317&#34;</span> <span style=color:#75715e># gRPC Accepts traces in OpenTelemetry OTLP format if --collector.otlp.enabled=true.</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;14318:4318&#34;</span> <span style=color:#75715e># HTTP Accepts traces in OpenTelemetry OTLP format if --collector.otlp.enabled=true.</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;14250:14250&#34;</span> <span style=color:#75715e># Used by jaeger-agent to send spans in model.proto format.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Collector</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>otel-collector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>otel/opentelemetry-collector:0.69.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>otel-collector</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: [ <span style=color:#e6db74>&#34;--config=/etc/otel-collector-config.yaml&#34;</span> ]
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./docker-data/otel-collector/log:/tmp/log</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;1888:1888&#34;</span>   <span style=color:#75715e># pprof extension</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;8888:8888&#34;</span>   <span style=color:#75715e># Prometheus&#39; metrics exposed by the collector</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;8889:8889&#34;</span>   <span style=color:#75715e># Prometheus exporter metrics</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;13133:13133&#34;</span> <span style=color:#75715e># health_check extension</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;4317:4317&#34;</span>   <span style=color:#75715e># OTLP gRPC receiver</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;4318:4318&#34;</span>   <span style=color:#75715e># OTLP http receiver</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;55679:55679&#34;</span> <span style=color:#75715e># zpages extension</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jaeger</span>
</span></span></code></pre></div><p>Then, still in our <code>docker-compose.yaml</code>, we need to add <code>jaeger</code> as our app dependency and <code>OTEL_EXPORTER_OTLP_ENDPOINT</code> variable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span> 14    depends_on:
</span></span><span style=display:flex><span> 15      - postgres
</span></span><span style=display:flex><span><span style=color:#a6e22e>+16      - jaeger
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 17    environment:
</span></span><span style=display:flex><span> 18      DATABASE_USERNAME: root
</span></span><span style=display:flex><span> 19      DATABASE_PASSWORD: password
</span></span><span style=display:flex><span> 20      DATABASE_DB_NAME: rails_otel_dev
</span></span><span style=display:flex><span> 21      PROGRAM_NAME: &#39;rails-otel&#39;
</span></span><span style=display:flex><span><span style=color:#a6e22e>+22     OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318 # via HTTP
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 23
</span></span></code></pre></div><p>As we need a file <code>otel-collector-config.yaml</code> to configure OpenTelemetry Collector, we need to create that file in our app root directory <code>otel-collector-config.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>receivers</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># Data sources: traces, metrics, logs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>otlp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocols</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>cors</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>allowed_origins</span>:
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;http://*&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;https://*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>processors</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>batch</span>: {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>exporters</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># Data sources: traces</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jaeger</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>endpoint</span>: <span style=color:#e6db74>&#34;jaeger:14250&#34;</span> <span style=color:#75715e># point to jaeger-agent to send spans in model.proto format.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tls</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>insecure</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Data sources: traces, metrics, logs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>logging</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbosity</span>: <span style=color:#ae81ff>detailed</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sampling_initial</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sampling_thereafter</span>: <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Data sources: traces, metrics, logs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/tmp/log/otel-log.json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>pipelines</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>traces</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>receivers</span>: [<span style=color:#ae81ff>otlp]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>processors</span>: [ <span style=color:#ae81ff>batch ]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>exporters</span>: [<span style=color:#ae81ff>jaeger, logging, file]</span>
</span></span></code></pre></div><p>The OpenTelemetry should have properly configured, now we can restart our service and let Docker to pull the <code>jaegertracing/all-in-one:1</code> and <code>otel/opentelemetry-collector:0.69.0</code> images.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker compose up --build --force-recreate
</span></span></code></pre></div><p>We will see the log like this:</p><p><img src=/blog/post-assets/2023-02-24/rails-log-after-install-otel-sdk.png alt="Figure 6. Rails Logger After Installing OpenTelemetry SDK"></p><div style=text-align:center;margin-bottom:30px>Figure 6. Rails Logger After Installing OpenTelemetry SDK</div><details><summary>Rails Logger After Installing OpenTelemetry SDK</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.293+00:00&#34;,&#34;msg&#34;:&#34;Booting Puma&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.293+00:00&#34;,&#34;msg&#34;:&#34;Rails 7.0.4.2 application starting in development &#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.293+00:00&#34;,&#34;msg&#34;:&#34;Run `bin/rails server --help` for more startup options&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.398800 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Trilogy failed to install
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.399313 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::ActiveSupport was successfully installed with the following options {}
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.400173 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::Rack was successfully installed with the following options {:allowed_request_headers=&gt;[], :allowed_response_headers=&gt;[], :application=&gt;nil, :record_frontend_span=&gt;false, :retain_middleware_names=&gt;false, :untraced_endpoints=&gt;[], :url_quantization=&gt;nil, :untraced_requests=&gt;nil, :response_propagators=&gt;[]}
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.403592 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::ActionPack was successfully installed with the following options {}
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.413223 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::ActiveJob was successfully installed with the following options {:propagation_style=&gt;:link, :force_flush=&gt;false, :span_naming=&gt;:queue}
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.498900 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::ActiveRecord was successfully installed with the following options {}
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.499400 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::ActionView was successfully installed with the following options {:disallowed_notification_payload_keys=&gt;[], :notification_payload_transform=&gt;nil}
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499417 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::AwsSdk failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499426 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Bunny failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499437 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::LMDB failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499445 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::HTTP failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499452 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Koala failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499459 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::ActiveModelSerializers failed to install
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.499879 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::ConcurrentRuby was successfully installed with the following options {}
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499895 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Dalli failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499903 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::DelayedJob failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499911 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Ethon failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499934 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Excon failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499945 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Faraday failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499952 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::GraphQL failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499959 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::HttpClient failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499969 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Mongo failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.499976 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Mysql2 failed to install
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.500488 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::Net::HTTP was successfully installed with the following options {:untraced_hosts=&gt;[]}
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.501739 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::PG was successfully installed with the following options {:peer_service=&gt;nil, :db_statement=&gt;:include}
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501754 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Que failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501761 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Racecar failed to install
</span></span><span style=display:flex><span>myapp  | I, [2023-03-31T06:24:56.501785 #1]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::Rails was successfully installed with the following options {}
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501794 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Rake failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501801 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Rdkafka failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501810 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Redis failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501817 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::RestClient failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501824 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Resque failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501833 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::RubyKafka failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501840 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Sidekiq failed to install
</span></span><span style=display:flex><span>myapp  | W, [2023-03-31T06:24:56.501847 #1]  WARN -- : Instrumentation: OpenTelemetry::Instrumentation::Sinatra failed to install
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.610+00:00&#34;,&#34;msg&#34;:&#34;Puma starting in single mode...&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.610+00:00&#34;,&#34;msg&#34;:&#34;Puma version: 5.6.5 (ruby 3.2.1-p31) (\&#34;Birdie&#39;s Version\&#34;)&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.610+00:00&#34;,&#34;msg&#34;:&#34;Min threads: 5&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.610+00:00&#34;,&#34;msg&#34;:&#34;Max threads: 5&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.610+00:00&#34;,&#34;msg&#34;:&#34;Environment: development&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.610+00:00&#34;,&#34;msg&#34;:&#34;PID: 1&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.610+00:00&#34;,&#34;msg&#34;:&#34;Listening on http://0.0.0.0:3000&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  |
</span></span><span style=display:flex><span>myapp  | {&#34;level&#34;:&#34;UNKNOWN&#34;,&#34;time&#34;:&#34;2023-03-31T06:24:56.610+00:00&#34;,&#34;msg&#34;:&#34;Use Ctrl-C to stop&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;e18b8780-a516-4f60-91f7-cc341cac7850&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}
</span></span><span style=display:flex><span>myapp  |
</span></span></code></pre></div></details><p><strong>Changes on this section can be seen at this commit
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/2c5eb6f1915ffcbce1cfee427819d6126992af73?diff=split">2c5eb6f</a>.</strong></p><h2 id=duck-typing-the-rubylogger>Duck-typing the Ruby::Logger
<a class=anchor href=#duck-typing-the-rubylogger>#</a></h2><p>In previous sub-section, we use
<a href=https://ruby-doc.org/3.2.1/stdlibs/logger/Logger.html>Ruby::Logger</a> as the
<a href=https://github.com/yusufsyaifudin/rails-otel/blob/2c5eb6f1915ffcbce1cfee427819d6126992af73/config/initializers/opentelemetry.rb#L68>OpenTelemetry SDK Logger</a>. Since we use Ruby 3.2.1 in
<a href=https://github.com/yusufsyaifudin/rails-otel/blob/2c5eb6f1915ffcbce1cfee427819d6126992af73/Gemfile#L4>Gemfile</a>, it should refer to this
<a href="https://github.com/ruby/ruby/blob/bb2c3601381d8ecb033e48825f3d0c2a387dddf2/doc/NEWS/NEWS-3.2.0.md?plain=1#L511">Ruby Logger</a>.</p><p>So, we can actually
<a href=https://en.wikipedia.org/wiki/Duck_typing>duck-type</a> the Ruby logger formatter class to format our log into JSON, by defining class and method argument same as in
<a href=https://github.com/ruby/logger/blob/v1.5.3/lib/logger/formatter.rb>this source</a> or in
<a href=https://github.com/ruby/logger/blob/4e8d9e27fd3b8f916cd3b370b97359f67e02c4bb/lib/logger/formatter.rb>this commit</a>.</p><p>To do that, create file <code>config/logger_json.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Logger</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Formatter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>call</span>(severity, time, program_name, message)
</span></span><span style=display:flex><span>      json_log <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>level</span>: severity,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>time</span>: time,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>msg</span>: message,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>trace_id</span>: <span style=color:#e6db74>&#39;00000000000000000000000000000000&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>span_id</span>: <span style=color:#e6db74>&#39;0000000000000000&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>trace_flags</span>: <span style=color:#e6db74>&#39;00&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>node_id</span>: <span style=color:#66d9ef>RAILS_NODE_ID</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>progname</span>: program_name <span style=color:#f92672>||</span> <span style=color:#66d9ef>PROGRAM_NAME</span>,
</span></span><span style=display:flex><span>      }<span style=color:#f92672>.</span>to_json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(json_log)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>And in file <code>config/boot.rb</code>, add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require_relative <span style=color:#e6db74>&#34;logger_json&#34;</span>
</span></span></code></pre></div><p>Now, if you recreate the Docker container, it will show all JSON log.</p><p><strong>Changes on this section can be seen at this commit
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/52d0dcad75c469248a8fb2362abe51d52a8558ec?diff=split">52d0dca</a>.</strong></p><h2 id=duck-typing-the-ruby-activerecord-logger>Duck-typing the Ruby ActiveRecord Logger
<a class=anchor href=#duck-typing-the-ruby-activerecord-logger>#</a></h2><blockquote><p>References of this section:</p><ul><li><a href=https://unfit-for.work/posts/2023/rails-structured-logging/>https://unfit-for.work/posts/2023/rails-structured-logging/</a></li><li><a href=https://medium.com/gojekengineering/structured-logging-in-rails-75e9a8c5370b>https://medium.com/gojekengineering/structured-logging-in-rails-75e9a8c5370b</a></li><li><a href=https://cbpowell.wordpress.com/2013/08/09/beautiful-logging-for-ruby-on-rails-4/>https://cbpowell.wordpress.com/2013/08/09/beautiful-logging-for-ruby-on-rails-4/</a></li></ul></blockquote><p>If we access the URL
<a href="http://localhost:3000/list-vouchers?token=%7byour-token%7d">http://localhost:3000/list-vouchers?token={your-token}</a> we still get the non-JSON formatted log. We need to duck typing the <code>ActiveRecord::Logger</code> too.</p><p>Write this file <code>config/logger_active_record_json.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;securerandom&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Class ActiveSupport::Logger will duck-type the original ActiveSupport::Logger class</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveSupport</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Logger</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># format_message will override the method format_message on Ruby class Logger here:</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># https://github.com/ruby/logger/blob/4e8d9e27fd3b8f916cd3b370b97359f67e02c4bb/lib/logger.rb#L742-L744</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 4e8d9e2 is the commit release of version https://github.com/ruby/logger/releases/tag/v1.5.3</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># This because ActiveSupport::Logger duck-typing (extends) class Logger as seen here</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># https://github.com/rails/rails/blob/7c70791470fc517deb7c640bead9f1b47efb5539/activesupport/lib/active_support/logger.rb#L8</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 7c70791 is commit id on release tag https://github.com/rails/rails/releases/tag/v7.0.4.2</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># format_message should return void, so we do return with no arguments</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># We print it as JSON.</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>format_message</span>(severity, timestamp, progname, msg)
</span></span><span style=display:flex><span>    <span style=color:#75715e># prepare log and print it</span>
</span></span><span style=display:flex><span>    log <span style=color:#f92672>=</span> format_json(severity, timestamp, progname, msg, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(log)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># format_json will format *args as JSON structured format.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># This function will return JSON, and not print it.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># The format MUST the same as format_message except this has &#34;attributes&#34; key.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># In Ruby, you can use the splat operator * to define a variadic argument,</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># which allows a method to accept an arbitrary number of arguments. To add type checking to a variadic argument,</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># you can use the syntax argname : Type*.</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>format_json</span>(severity, time, progname, msg, data, <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>    current_span <span style=color:#f92672>=</span> <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Trace</span><span style=color:#f92672>.</span>current_span
</span></span><span style=display:flex><span>    trace_id <span style=color:#f92672>=</span> current_span<span style=color:#f92672>.</span>context<span style=color:#f92672>.</span>trace_id
</span></span><span style=display:flex><span>    hex_trace_id <span style=color:#f92672>=</span> trace_id<span style=color:#f92672>.</span>unpack1(<span style=color:#e6db74>&#39;H*&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    span_id <span style=color:#f92672>=</span> current_span<span style=color:#f92672>.</span>context<span style=color:#f92672>.</span>span_id
</span></span><span style=display:flex><span>    hex_span_id <span style=color:#f92672>=</span> span_id<span style=color:#f92672>.</span>unpack1(<span style=color:#e6db74>&#39;H*&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    attributes <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>    args<span style=color:#f92672>.</span>each_with_index <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>arg, index<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># The next argument can be anything.</span>
</span></span><span style=display:flex><span>      attributes<span style=color:#f92672>.</span>push(arg)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e># prepare log and return it</span>
</span></span><span style=display:flex><span>    log <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>level</span>: severity,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>time</span>: time,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>msg</span>: msg,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>trace_id</span>: hex_trace_id,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>span_id</span>: hex_span_id,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>trace_flags</span>: <span style=color:#e6db74>&#39;00&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>node_id</span>: <span style=color:#66d9ef>RAILS_NODE_ID</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>progname</span>: progname <span style=color:#f92672>||</span> <span style=color:#66d9ef>PROGRAM_NAME</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get request id from Thread context.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># It must not be empty since we should always set it in the first middleware.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>Thread</span><span style=color:#f92672>.</span>current<span style=color:#f92672>[</span><span style=color:#e6db74>:request_id</span><span style=color:#f92672>].</span>nil? <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>Thread</span><span style=color:#f92672>.</span>current<span style=color:#f92672>[</span><span style=color:#e6db74>:request_id</span><span style=color:#f92672>].</span>empty?
</span></span><span style=display:flex><span>      log<span style=color:#f92672>[</span><span style=color:#e6db74>:request_id</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Thread</span><span style=color:#f92672>.</span>current<span style=color:#f92672>[</span><span style=color:#e6db74>:request_id</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Check if a variable is a Hash using instance_of?</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If data is not a Hash, it will become attributes.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>data<span style=color:#f92672>.</span>nil? <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>data<span style=color:#f92672>.</span>empty?
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> data<span style=color:#f92672>.</span>instance_of?(<span style=color:#66d9ef>Hash</span>)
</span></span><span style=display:flex><span>        log<span style=color:#f92672>[</span><span style=color:#e6db74>:data</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> data
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        attributes<span style=color:#f92672>.</span>push(data)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>attributes<span style=color:#f92672>.</span>nil? <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>attributes<span style=color:#f92672>.</span>empty?
</span></span><span style=display:flex><span>      log<span style=color:#f92672>[</span><span style=color:#e6db74>:attributes</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> attributes
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> log<span style=color:#f92672>.</span>to_json
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># debug_ctx will format the arguments as JSON and the print it using STDOUT.puts</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># This uses block (debug{}) instead of function call (debug()) to make it memory efficient.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># https://stackoverflow.com/a/30144402</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Since the original Ruby ::Logger has debug, info, warn, error, fatal and unknown logger,</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># we add suffixes _ctx which take multiple arguments and the first argument must String which is the message log.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># We get the program name using self as it access the parent class:</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># https://github.com/ruby/logger/blob/4e8d9e27fd3b8f916cd3b370b97359f67e02c4bb/lib/logger.rb#L420-L421</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>debug_ctx</span>(msg, data, <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>debug <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      log <span style=color:#f92672>=</span> format_json(<span style=color:#e6db74>&#34;DEBUG&#34;</span>, <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now, self<span style=color:#f92672>.</span>progname, msg, data, <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(log)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>info_ctx</span>(msg, data, <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>info <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      log <span style=color:#f92672>=</span> format_json(<span style=color:#e6db74>&#34;INFO&#34;</span>, <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now, self<span style=color:#f92672>.</span>progname, msg, data, <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(log)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>warn_ctx</span>(msg, data)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>warn <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      log <span style=color:#f92672>=</span> format_json(<span style=color:#e6db74>&#34;WARN&#34;</span>, <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now, self<span style=color:#f92672>.</span>progname, msg, data, <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(log)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>error_ctx</span>(msg, data)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>error <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      log <span style=color:#f92672>=</span> format_json(<span style=color:#e6db74>&#34;ERROR&#34;</span>, <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now, self<span style=color:#f92672>.</span>progname, msg, data, <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(log)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fatal_ctx</span>(msg, data)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>fatal <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      log <span style=color:#f92672>=</span> format_json(<span style=color:#e6db74>&#34;FATAL&#34;</span>, <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now, self<span style=color:#f92672>.</span>progname, msg, data, <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(log)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>unknown_ctx</span>(msg, data, <span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>debug <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      log <span style=color:#f92672>=</span> format_json(<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>, <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now, self<span style=color:#f92672>.</span>progname, msg, data)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>STDOUT</span><span style=color:#f92672>.</span>puts(log)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span> <span style=color:#75715e># end of class Json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>MyLogger</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>ActiveSupport</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Logger</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>STDOUT</span>)
</span></span></code></pre></div><p>Then import that file from <code>config/boot.rb</code>, add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require_relative <span style=color:#e6db74>&#34;logger_active_record_json&#34;</span>
</span></span></code></pre></div><p>Restart the server and now access our endpoint
<a href="http://localhost:3000/list-vouchers?token=%7byour-token%7d">http://localhost:3000/list-vouchers?token={your-token}</a>. Now, our log must show all log in JSON format output:</p><p><img src=/blog/post-assets/2023-02-24/rails-log-after-duck-typing-activerecord-logger.png alt="Figure 7. Rails Logger After Duck-Typing ActiveRecord::Logger"></p><div style=text-align:center;margin-bottom:30px>Figure 7. Rails Logger After Duck-Typing ActiveRecord::Logger</div><details><summary>Rails Logger After Duck-Typing ActiveRecord::Logger</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.328+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Booting Puma&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.328+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Rails 7.0.4.2 application starting in development &#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.328+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Run `bin/rails server --help` for more startup options&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.440+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Trilogy failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.441+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::ActiveSupport was successfully installed with the following options {}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.442+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Rack was successfully installed with the following options {:allowed_request_headers=\u003e[], :allowed_response_headers=\u003e[], :application=\u003enil, :record_frontend_span=\u003efalse, :retain_middleware_names=\u003efalse, :untraced_endpoints=\u003e[], :url_quantization=\u003enil, :untraced_requests=\u003enil, :response_propagators=\u003e[]}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.445+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::ActionPack was successfully installed with the following options {}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.455+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::ActiveJob was successfully installed with the following options {:propagation_style=\u003e:link, :force_flush=\u003efalse, :span_naming=\u003e:queue}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.558+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::ActiveRecord was successfully installed with the following options {}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.559+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::ActionView was successfully installed with the following options {:disallowed_notification_payload_keys=\u003e[], :notification_payload_transform=\u003enil}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.559+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::AwsSdk failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.559+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Bunny failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.559+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::LMDB failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.559+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::HTTP failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.559+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Koala failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.559+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::ActiveModelSerializers failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::ConcurrentRuby was successfully installed with the following options {}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Dalli failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::DelayedJob failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Ethon failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Excon failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Faraday failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::GraphQL failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::HttpClient failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Mongo failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.560+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Mysql2 failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.561+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Net::HTTP was successfully installed with the following options {:untraced_hosts=\u003e[]}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.562+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::PG was successfully installed with the following options {:peer_service=\u003enil, :db_statement=\u003e:include}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.562+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Que failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.562+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Racecar failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.562+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Rails was successfully installed with the following options {}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.562+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Rake failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.562+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Rdkafka failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.563+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Redis failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.563+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::RestClient failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.563+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Resque failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.563+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::RubyKafka failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.563+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Sidekiq failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;WARN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.563+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Instrumentation: OpenTelemetry::Instrumentation::Sinatra failed to install&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Puma starting in single mode...&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Puma version: 5.6.5 (ruby 3.2.1-p31) (\&#34;Birdie&#39;s Version\&#34;)&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Min threads: 5&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Max threads: 5&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Environment: development&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;PID: 1&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Listening on http://0.0.0.0:3000&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;UNKNOWN&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:40.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Use Ctrl-C to stop&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;00000000000000000000000000000000&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;0000000000000000&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.537+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Started GET \&#34;/list-vouchers?token=[FILTERED]\&#34; for 172.19.0.1 at 2023-04-03 09:39:51 +0000&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.537+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Started GET \&#34;/list-vouchers?token=[FILTERED]\&#34; for 172.19.0.1 at 2023-04-03 09:39:51 +0000&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.538+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Cannot render console from 172.19.0.1! Allowed networks: 127.0.0.0/127.255.255.255, ::1&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.539+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Cannot render console from 172.19.0.1! Allowed networks: 127.0.0.0/127.255.255.255, ::1&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.661+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;  \u001b[1m\u001b[36mActiveRecord::SchemaMigration Pluck (3.4ms)\u001b[0m  \u001b[1m\u001b[34mSELECT \&#34;schema_migrations\&#34;.\&#34;version\&#34; FROM \&#34;schema_migrations\&#34; ORDER BY \&#34;schema_migrations\&#34;.\&#34;version\&#34; ASC\u001b[0m&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.661+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;  \u001b[1m\u001b[36mActiveRecord::SchemaMigration Pluck (3.4ms)\u001b[0m  \u001b[1m\u001b[34mSELECT \&#34;schema_migrations\&#34;.\&#34;version\&#34; FROM \&#34;schema_migrations\&#34; ORDER BY \&#34;schema_migrations\&#34;.\&#34;version\&#34; ASC\u001b[0m&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.690+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Processing by UserPromotionController#list_vouchers as HTML&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.690+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Processing by UserPromotionController#list_vouchers as HTML&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.690+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;  Parameters: {\&#34;token\&#34;=\u003e\&#34;[FILTERED]\&#34;}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.690+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;  Parameters: {\&#34;token\&#34;=\u003e\&#34;[FILTERED]\&#34;}&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;request accepted by controller&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;request accepted by controller&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.694+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;accepting token from query params&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.695+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;accepting token from query params&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.695+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;validating JWT&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.695+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;validating JWT&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.697+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;reaching business logic&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.697+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;reaching business logic&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.697+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;doing query get user by id c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.697+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;doing query get user by id c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.706+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;  \u001b[1m\u001b[36mUser Load (1.5ms)\u001b[0m  \u001b[1m\u001b[34mSELECT \&#34;users\&#34;.* FROM \&#34;users\&#34; WHERE \&#34;users\&#34;.\&#34;id\&#34; = $1 LIMIT $2\u001b[0m  [[\&#34;id\&#34;, \&#34;c8c6991c-687e-44cc-8755-4743ef66d265\&#34;], [\&#34;LIMIT\&#34;, 1]]&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;64b1c2051f3fdefa&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.706+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;  \u001b[1m\u001b[36mUser Load (1.5ms)\u001b[0m  \u001b[1m\u001b[34mSELECT \&#34;users\&#34;.* FROM \&#34;users\&#34; WHERE \&#34;users\&#34;.\&#34;id\&#34; = $1 LIMIT $2\u001b[0m  [[\&#34;id\&#34;, \&#34;c8c6991c-687e-44cc-8755-4743ef66d265\&#34;], [\&#34;LIMIT\&#34;, 1]]&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;64b1c2051f3fdefa&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.707+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;  ↳ app/services/vouchers/user_voucher.rb:7:in `vouchers&#39;&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;64b1c2051f3fdefa&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.707+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;  ↳ app/services/vouchers/user_voucher.rb:7:in `vouchers&#39;&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;64b1c2051f3fdefa&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.713+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;calling PromotionService.list_vouchers from UserVoucher.list_vouchers c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.713+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;calling PromotionService.list_vouchers from UserVoucher.list_vouchers c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.715+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;PromotionService.list_vouchers call started&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:51.715+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;PromotionService.list_vouchers call started&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:52.127+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;PromotionService.list_vouchers done&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:52.128+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;PromotionService.list_vouchers done&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:52.129+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;controller done processing the request, preparing rendering response&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:52.129+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;controller done processing the request, preparing rendering response&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:52.140+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Completed 200 OK in 450ms (Views: 5.5ms | ActiveRecord: 5.8ms | Allocations: 11549)\n\n&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>myapp</span>  <span style=color:#960050;background-color:#1e0010>|</span> {<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;INFO&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T09:39:52.141+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Completed 200 OK in 450ms (Views: 5.5ms | ActiveRecord: 5.8ms | Allocations: 11549)\n\n&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;4862c816e54cf50f3d0147068a88ccc7&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;872682563d412c74&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;ac8d3e07-387e-4287-ac2f-4f9414c5504f&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span></code></pre></div></details><p>Now, as we already add the Jaeger service in the section
<a href=/posts/2023-02-24-rails-otel-part2/#add-opentelemetry-sdk>Add OpenTelemetry SDK</a>, we can see our trace in Jaeger dashboard by accessing
<a href=http://localhost:16686/search>JaegerUI http://localhost:16686/search</a>.</p><p>And we will see one trace like this (because we only do request once only):</p><p><img src=/blog/post-assets/2023-02-24/jaegerui-after-duck-typing-activerecord-logger.png alt="Figure 8. JaegerUI To See App Trace"></p><div style=text-align:center;margin-bottom:30px>Figure 8. JaegerUI To See App Trace</div><p>In our log we see that we have a trace id <strong>4862c816e54cf50f3d0147068a88ccc7</strong> and, it match with the Trace ID shown in JaegerUI in
<a href=http://localhost:16686/trace/4862c816e54cf50f3d0147068a88ccc7>http://localhost:16686/trace/4862c816e54cf50f3d0147068a88ccc7</a>.</p><p>So, we have two questions:</p><ol><li>How to make this trace id available from the client side? To do this, we want to add key <code>Traceparent</code> available in HTTP response header by creating OpenTelemetry Middleware. This comply with the
<a href=https://www.w3.org/TR/trace-context/#header-name>W3 Recommendation</a>.</li><li>What is additional function with suffixes <code>_ctx</code> such as <code>debug_ctx</code>, <code>info_ctx</code>, etc do? And how to use that? I will cover it in the section</li></ol><p><strong>Changes on this section can be seen at this commit
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/e7ad9f7d8d23634d5bcc6ae20e21bca29b8c39a1?diff=split">e7ad9f7</a>.</strong></p><h2 id=creating-opentelemetry-middleware>Creating OpenTelemetry Middleware
<a class=anchor href=#creating-opentelemetry-middleware>#</a></h2><p>We need to create a OpenTelemetry middleware in the first middleware stack to ensure:</p><ol><li>If the endpoint is called from another service that already start the tracer, we only need to continue from that tracer ID as the parent. If we don&rsquo;t do this, it will create new trace that not correlate with the previous trace &ndash; and this is bad, because we can&rsquo;t observe and correlate the API calls.</li><li>We add <code>Traceparent</code> in response header. This way, the caller (or client who call the app) can see the Trace ID produced by the app.</li><li>We print access log in this middleware to ensure we can get request-response log.</li></ol><p>To do that, create a file <code>config/middleware_otel.rb</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;securerandom&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#34;opentelemetry/sdk&#34;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;rack/request&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require_relative <span style=color:#e6db74>&#34;logger_active_record_json&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># # Export traces to console by default</span>
</span></span><span style=display:flex><span><span style=color:#75715e># # see https://github.com/open-telemetry/opentelemetry-ruby/blob/opentelemetry-sdk/v1.2.0/sdk/lib/opentelemetry/sdk/configurator.rb#L175-L197</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ENV[&#39;OTEL_TRACES_EXPORTER&#39;] ||= &#39;otlp&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># # Configure propagator</span>
</span></span><span style=display:flex><span><span style=color:#75715e># # see https://github.com/open-telemetry/opentelemetry-ruby/blob/opentelemetry-sdk/v1.2.0/sdk/lib/opentelemetry/sdk/configurator.rb#L199-L216</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ENV[&#39;OTEL_PROPAGATORS&#39;] ||= &#39;tracecontext,baggage,b3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># MiddlewareLogger this code is based on below link with modification.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># https://github.com/open-telemetry/opentelemetry-ruby/blob/opentelemetry-sdk/v1.2.0/examples/http/server.rb</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> MiddlewareLogger
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestContextMiddleware</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(app)
</span></span><span style=display:flex><span>      @app <span style=color:#f92672>=</span> app
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>call</span>(env)
</span></span><span style=display:flex><span>      start_time <span style=color:#f92672>=</span> <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Extract context from request headers.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># This to continue the span if client has sent some propagator key into request header.</span>
</span></span><span style=display:flex><span>      context <span style=color:#f92672>=</span> <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>.</span>propagation<span style=color:#f92672>.</span>extract(
</span></span><span style=display:flex><span>        env,
</span></span><span style=display:flex><span>        <span style=color:#75715e># see https://github.com/open-telemetry/opentelemetry-ruby/blob/opentelemetry-sdk/v1.2.0/common/lib/opentelemetry/common/propagation.rb#L22</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># and https://github.com/open-telemetry/opentelemetry-ruby/blob/opentelemetry-sdk/v1.2.0/common/lib/opentelemetry/common/propagation/rack_env_getter.rb</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>getter</span>: <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Common</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Propagation</span><span style=color:#f92672>.</span>rack_env_getter,
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Example: get OpenTelemetry trace id.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Trace ID will always the same as traceparent (if exist and continue from client),</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># or from new current span.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># trace_id = OpenTelemetry::Trace.current_span.context.trace_id.unpack1(&#39;H*&#39;) # Unpack to hex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># We use MyAppTracer that we defined in config/initializers/opentelemetry.rb</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># For attribute naming, see</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># https://github.com/open-telemetry/opentelemetry-specification/blob/v1.19.0/specification/trace/semantic_conventions/http.md#http-server</span>
</span></span><span style=display:flex><span>      attributes <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;component&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;http&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;http.method&#39;</span> <span style=color:#f92672>=&gt;</span> env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;REQUEST_METHOD&#39;</span><span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;http.route&#39;</span> <span style=color:#f92672>=&gt;</span> env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;PATH_INFO&#39;</span><span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;http.url&#39;</span> <span style=color:#f92672>=&gt;</span> env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;REQUEST_URI&#39;</span><span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Span name SHOULD be set to route:</span>
</span></span><span style=display:flex><span>      span_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;REQUEST_METHOD&#39;</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>#{</span>env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;PATH_INFO&#39;</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>      span <span style=color:#f92672>=</span> <span style=color:#66d9ef>MyAppTracer</span><span style=color:#f92672>.</span>start_span(span_name, <span style=color:#e6db74>with_parent</span>: context, <span style=color:#e6db74>attributes</span>: attributes)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Extract relevant information from the request object</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># see full object here https://rubydoc.info/gems/rack/Rack/Request</span>
</span></span><span style=display:flex><span>      request <span style=color:#f92672>=</span> <span style=color:#66d9ef>Rack</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Request</span><span style=color:#f92672>.</span>new(env)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      req_method <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>request_method <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>      req_path <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>path <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>      req_url <span style=color:#f92672>=</span> env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;REQUEST_URI&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>      req_user_agent <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>user_agent <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>      req_remote_ip <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>ip <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Get X-Request-ID value header. This is non W3 standard headers: https://stackoverflow.com/a/27174552</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># But, Heroku has blog about this https://blog.heroku.com/http_request_id_s_improve_visibility_across_the_application_stack</span>
</span></span><span style=display:flex><span>      request_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>SecureRandom</span><span style=color:#f92672>.</span>uuid()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Get header request values</span>
</span></span><span style=display:flex><span>      req_headers <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>      req_headers_filter <span style=color:#f92672>=</span> env<span style=color:#f92672>.</span>select { <span style=color:#f92672>|</span>key, value<span style=color:#f92672>|</span> key<span style=color:#f92672>.</span>start_with?(<span style=color:#e6db74>&#39;HTTP_&#39;</span>) }
</span></span><span style=display:flex><span>      req_headers_filter<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>key, value<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> key<span style=color:#f92672>.</span>downcase <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;X-Request-ID&#39;</span><span style=color:#f92672>.</span>downcase
</span></span><span style=display:flex><span>            request_id <span style=color:#f92672>=</span> value<span style=color:#f92672>.</span>chomp()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        req_headers<span style=color:#f92672>[</span>key<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Pass the information to the logger</span>
</span></span><span style=display:flex><span>      log_data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>request</span>: {
</span></span><span style=display:flex><span>          method: req_method,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>path</span>: req_path,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>url</span>: req_url,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>user_agent</span>: req_user_agent,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>remote_ip</span>: req_remote_ip,
</span></span><span style=display:flex><span>          <span style=color:#75715e># uncomment if you need all request header passed in every log.</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># But, this will return a big object that makes your log hard to see.</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># header: req_headers,</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Prepare default response</span>
</span></span><span style=display:flex><span>      resp_status, resp_headers, resp_body <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>, {}, <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Activate the extracted context</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># set the span as the current span in the OpenTelemetry context</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Trace</span><span style=color:#f92672>.</span>with_span(span) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Call the next middleware in the chain</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Run application stack</span>
</span></span><span style=display:flex><span>        span<span style=color:#f92672>.</span>set_attribute(<span style=color:#e6db74>&#39;request_id&#39;</span>, request_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        resp_status, resp_headers, resp_body <span style=color:#f92672>=</span> @app<span style=color:#f92672>.</span>call(env)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        span<span style=color:#f92672>.</span>set_attribute(<span style=color:#e6db74>&#39;http.status_code&#39;</span>, resp_status)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Inject &#34;traceparent&#34; to header response</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># see https://github.com/open-telemetry/opentelemetry-ruby/blob/opentelemetry-sdk/v1.2.0/sdk/lib/opentelemetry/sdk/configurator.rb#L17</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>OpenTelemetry</span><span style=color:#f92672>.</span>propagation<span style=color:#f92672>.</span>inject(resp_headers)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Inject &#34;X-Request-Id&#34; to header response.</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># The request id must the same as request id if any, if not we already generated one during getting request headers.</span>
</span></span><span style=display:flex><span>      resp_headers<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;X-Request-Id&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> request_id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      log_data<span style=color:#f92672>[</span><span style=color:#e6db74>:response</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>status</span>: resp_status,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>header</span>: resp_headers,
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># return the response after it processed on the next call</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> resp_status, resp_headers, resp_body
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>rescue</span> <span style=color:#66d9ef>Exception</span> <span style=color:#f92672>=&gt;</span> e
</span></span><span style=display:flex><span>      <span style=color:#75715e># set the span status to error if an exception is raised</span>
</span></span><span style=display:flex><span>      span<span style=color:#f92672>.</span>record_exception(e)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># re-raise the exception</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>raise</span> e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ensure</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>MyLogger</span><span style=color:#f92672>.</span>info_ctx(<span style=color:#e6db74>&#39;access log&#39;</span>, log_data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Clear the request context data from the thread-local variable</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Thread</span><span style=color:#f92672>.</span>current<span style=color:#f92672>[</span><span style=color:#e6db74>:request_id</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># end the span when the request is complete</span>
</span></span><span style=display:flex><span>      span<span style=color:#f92672>.</span>finish
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>And in the file <code>config/application.rb</code> we need to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require_relative <span style=color:#e6db74>&#34;middleware_otel&#34;</span>
</span></span></code></pre></div><p>and add this config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># push the MiddlewareLogger::RequestContextMiddleware to head of middleware stack</span>
</span></span><span style=display:flex><span>config<span style=color:#f92672>.</span>middleware<span style=color:#f92672>.</span>insert_before(<span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>MiddlewareLogger</span><span style=color:#f92672>::</span><span style=color:#66d9ef>RequestContextMiddleware</span>)
</span></span></code></pre></div><p>Again, restart the application and make some requests. To validate that we already put the <code>Traceparent</code> in the response header, we can use <code>curl</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v http://localhost:3000/list-vouchers?token<span style=color:#f92672>={</span>your-token<span style=color:#f92672>}</span>
</span></span></code></pre></div><p><img src=/blog/post-assets/2023-02-24/curl-to-validate-traceparent-header-response.png alt="Figure 9. cURL To Validate Traceparent Header"></p><div style=text-align:center;margin-bottom:30px>Figure 9. cURL To Validate Traceparent Header</div><details><summary>cURL To Validate Traceparent Header</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v http://localhost:3000/list-vouchers<span style=color:#ae81ff>\?</span>token<span style=color:#ae81ff>\=</span>eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYzhjNjk5MWMtNjg3ZS00NGNjLTg3NTUtNDc0M2VmNjZkMjY1In0.TCrEUFziQY4800jAT9ioY2mOm_b9eLdC20gtXjdTt14
</span></span><span style=display:flex><span>*   Trying 127.0.0.1:3000...
</span></span><span style=display:flex><span>* Connected to localhost <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> port <span style=color:#ae81ff>3000</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /list-vouchers?token<span style=color:#f92672>=</span>eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYzhjNjk5MWMtNjg3ZS00NGNjLTg3NTUtNDc0M2VmNjZkMjY1In0.TCrEUFziQY4800jAT9ioY2mOm_b9eLdC20gtXjdTt14 HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: localhost:3000
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.86.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>&lt; X-Frame-Options: SAMEORIGIN
</span></span><span style=display:flex><span>&lt; X-XSS-Protection: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>&lt; X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>&lt; X-Download-Options: noopen
</span></span><span style=display:flex><span>&lt; X-Permitted-Cross-Domain-Policies: none
</span></span><span style=display:flex><span>&lt; Referrer-Policy: strict-origin-when-cross-origin
</span></span><span style=display:flex><span>&lt; Content-Type: */*; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>&lt; Vary: Accept
</span></span><span style=display:flex><span>&lt; ETag: W/<span style=color:#e6db74>&#34;0a89d7478ece4a7e8d2b8acbc102aff6&#34;</span>
</span></span><span style=display:flex><span>&lt; Cache-Control: max-age<span style=color:#f92672>=</span>0, private, must-revalidate
</span></span><span style=display:flex><span>&lt; X-Request-Id: b243ea12-3394-4c49-8faa-ae6f266ff1b7
</span></span><span style=display:flex><span>&lt; X-Runtime: 0.460178
</span></span><span style=display:flex><span>&lt; Server-Timing: start_processing.action_controller;dur<span style=color:#f92672>=</span>0.32, sql.active_record;dur<span style=color:#f92672>=</span>1.08, instantiation.active_record;dur<span style=color:#f92672>=</span>0.04, process_action.action_controller;dur<span style=color:#f92672>=</span>437.60
</span></span><span style=display:flex><span>&lt; traceparent: 00-a1ac0334fcb72ad1513859d416b5ff26-b819e2324b94eacd-01
</span></span><span style=display:flex><span>&lt; Transfer-Encoding: chunked
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span>* Connection <span style=color:#75715e>#0 to host localhost left intact</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;user&#34;</span>:<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span>,<span style=color:#e6db74>&#34;username&#34;</span>:<span style=color:#e6db74>&#34;jane&#34;</span>,<span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Jane Kepiye Karepe To&#34;</span>,<span style=color:#e6db74>&#34;created_at&#34;</span>:<span style=color:#e6db74>&#34;2023-03-02T09:15:51.346Z&#34;</span>,<span style=color:#e6db74>&#34;updated_at&#34;</span>:<span style=color:#e6db74>&#34;2023-03-02T09:15:51.346Z&#34;</span><span style=color:#f92672>}</span>,<span style=color:#e6db74>&#34;vouchers&#34;</span>:<span style=color:#f92672>[[{</span><span style=color:#e6db74>&#34;voucher_code&#34;</span>:<span style=color:#e6db74>&#34;REGISTER_ANNIVERSARY&#34;</span>,<span style=color:#e6db74>&#34;description&#34;</span>:<span style=color:#e6db74>&#34;will get 5% discount if user is a loyal users (already joined minimum 1 year)&#34;</span>,<span style=color:#e6db74>&#34;terms_and_conditions&#34;</span>:<span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;discount&#34;</span>:5,<span style=color:#e6db74>&#34;min_registered_year&#34;</span>:1,<span style=color:#e6db74>&#34;registered_date_is_same&#34;</span>:true,<span style=color:#e6db74>&#34;registered_month_is_same&#34;</span>:true,<span style=color:#e6db74>&#34;name_prefix&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>}]}]</span>,<span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;voucher_code&#34;</span>:<span style=color:#e6db74>&#34;I_AM_JAN&#34;</span>,<span style=color:#e6db74>&#34;description&#34;</span>:<span style=color:#e6db74>&#34;will get 1% discount if user have name prefix &#39;jan&#39; because our app is launched at January!&#34;</span>,<span style=color:#e6db74>&#34;terms_and_conditions&#34;</span>:<span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;discount&#34;</span>:1,<span style=color:#e6db74>&#34;min_registered_year&#34;</span>:0,<span style=color:#e6db74>&#34;registered_date_is_same&#34;</span>:false,<span style=color:#e6db74>&#34;registered_month_is_same&#34;</span>:false,<span style=color:#e6db74>&#34;name_prefix&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>}]}]]}</span>
</span></span></code></pre></div></details><p>Also, in the application log, we will see access log with JSON format (Figure 10). We produce request-response data inside field <code>data</code> in the log.</p><p><img src=/blog/post-assets/2023-02-24/rails-log-after-installing-otel-middleware.png alt="Figure 10. Application Log After Adding OpenTelemetry Middleware"></p><div style=text-align:center;margin-bottom:30px>Figure 10. Application Log After Adding OpenTelemetry Middleware</div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;level&#34;</span>: <span style=color:#e6db74>&#34;INFO&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;time&#34;</span>: <span style=color:#e6db74>&#34;2023-04-03T10:14:17.202+00:00&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;access log&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;trace_id&#34;</span>: <span style=color:#e6db74>&#34;a1ac0334fcb72ad1513859d416b5ff26&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;span_id&#34;</span>: <span style=color:#e6db74>&#34;b819e2324b94eacd&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;trace_flags&#34;</span>: <span style=color:#e6db74>&#34;00&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;node_id&#34;</span>: <span style=color:#e6db74>&#34;249e7240-36af-49b9-8f82-6cfb2870de34&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;progname&#34;</span>: <span style=color:#e6db74>&#34;rails-otel&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;request&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;method&#34;</span>: <span style=color:#e6db74>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/list-vouchers&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;/list-vouchers?token=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYzhjNjk5MWMtNjg3ZS00NGNjLTg3NTUtNDc0M2VmNjZkMjY1In0.TCrEUFziQY4800jAT9ioY2mOm_b9eLdC20gtXjdTt14&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;user_agent&#34;</span>: <span style=color:#e6db74>&#34;curl/7.86.0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;remote_ip&#34;</span>: <span style=color:#e6db74>&#34;172.19.0.1&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;response&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;header&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;X-Frame-Options&#34;</span>: <span style=color:#e6db74>&#34;SAMEORIGIN&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;X-XSS-Protection&#34;</span>: <span style=color:#e6db74>&#34;0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;X-Content-Type-Options&#34;</span>: <span style=color:#e6db74>&#34;nosniff&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;X-Download-Options&#34;</span>: <span style=color:#e6db74>&#34;noopen&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;X-Permitted-Cross-Domain-Policies&#34;</span>: <span style=color:#e6db74>&#34;none&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Referrer-Policy&#34;</span>: <span style=color:#e6db74>&#34;strict-origin-when-cross-origin&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;*/*; charset=utf-8&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Vary&#34;</span>: <span style=color:#e6db74>&#34;Accept&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;ETag&#34;</span>: <span style=color:#e6db74>&#34;W/\&#34;0a89d7478ece4a7e8d2b8acbc102aff6\&#34;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Cache-Control&#34;</span>: <span style=color:#e6db74>&#34;max-age=0, private, must-revalidate&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;X-Request-Id&#34;</span>: <span style=color:#e6db74>&#34;b243ea12-3394-4c49-8faa-ae6f266ff1b7&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;X-Runtime&#34;</span>: <span style=color:#e6db74>&#34;0.460178&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Server-Timing&#34;</span>: <span style=color:#e6db74>&#34;start_processing.action_controller;dur=0.32, sql.active_record;dur=1.08, instantiation.active_record;dur=0.04, process_action.action_controller;dur=437.60&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;traceparent&#34;</span>: <span style=color:#e6db74>&#34;00-a1ac0334fcb72ad1513859d416b5ff26-b819e2324b94eacd-01&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;latency&#34;</span>: <span style=color:#ae81ff>467.365584</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Changes on this section can be seen at this commit
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/5467b1bb2c3dc7eaacc58ee65701ed6d1d6b8b89?diff=split">5467b1b</a>.</strong></p><h2 id=using-custom-logger-function>Using Custom Logger Function
<a class=anchor href=#using-custom-logger-function>#</a></h2><p>If you follow this tutorial carefully, you may notice that we now have new logger class called <code>MyLogger</code> that replace (duck-typing) the <code>ActiveRecord::Logger</code>. In the previous section we use <code>MyLogger.info_ctx</code> which takes 2 arguments. In <code>Rails.logger.info</code> it only accepts one argument, and will return error when we pass more arguments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>MyLogger</span><span style=color:#f92672>.</span>info_ctx(<span style=color:#e6db74>&#34;message&#34;</span>, {<span style=color:#e6db74>key</span>: <span style=color:#e6db74>&#34;value on data&#34;</span>}, {<span style=color:#e6db74>attribute</span>: <span style=color:#ae81ff>1</span>}, {<span style=color:#e6db74>attribute</span>: <span style=color:#e6db74>&#34;two&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#75715e># {&#34;level&#34;:&#34;INFO&#34;,&#34;time&#34;:&#34;2023-04-03T10:22:49.453+00:00&#34;,&#34;msg&#34;:&#34;message&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;6f8d4021-f917-4ee7-84f4-2aa903ba6e63&#34;,&#34;progname&#34;:&#34;rails-otel&#34;,&#34;data&#34;:{&#34;key&#34;:&#34;value on data&#34;},&#34;attributes&#34;:[{&#34;attribute&#34;:1},{&#34;attribute&#34;:&#34;two&#34;}]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;message&#34;</span>, {<span style=color:#e6db74>key</span>: <span style=color:#e6db74>&#34;value on data&#34;</span>}, {<span style=color:#e6db74>attribute</span>: <span style=color:#ae81ff>1</span>}, {<span style=color:#e6db74>attribute</span>: <span style=color:#e6db74>&#34;two&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#75715e># /usr/local/lib/ruby/3.2.0/logger.rb:694:in `info&#39;: wrong number of arguments (given 4, expected 0..1) (ArgumentError)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;message&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># {&#34;level&#34;:&#34;INFO&#34;,&#34;time&#34;:&#34;2023-04-03T10:23:14.739+00:00&#34;,&#34;msg&#34;:&#34;message&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;6f8d4021-f917-4ee7-84f4-2aa903ba6e63&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}</span>
</span></span><span style=display:flex><span><span style=color:#75715e># {&#34;level&#34;:&#34;INFO&#34;,&#34;time&#34;:&#34;2023-04-03T10:23:14.739+00:00&#34;,&#34;msg&#34;:&#34;message&#34;,&#34;trace_id&#34;:&#34;00000000000000000000000000000000&#34;,&#34;span_id&#34;:&#34;0000000000000000&#34;,&#34;trace_flags&#34;:&#34;00&#34;,&#34;node_id&#34;:&#34;6f8d4021-f917-4ee7-84f4-2aa903ba6e63&#34;,&#34;progname&#34;:&#34;rails-otel&#34;}</span>
</span></span></code></pre></div><p>All new function that we write in section
<a href=/posts/2023-02-24-rails-otel-part2/#duck-typing-the-ruby-activerecord-logger>Duck-typing the Ruby ActiveRecord Logger</a> is to make our life easier to produce the log with data. For example, in access log we need a data with structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;request&#34;</span>: {}, 
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;response&#34;</span>: {}
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>But in another case such as publishing message to Kafka we only want to produce data with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;kafka_topic&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;payload&#34;</span>: {}
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Also, we accept the 3rd arguments as an optional parameter. It can accepts any value as long as it can be decoded into JSON (i.e: Hash as JSON object, Array as JSON array, etc). It useful when we want to add some information that only available in certain function. For example, we cannot get the <code>username</code> from the access log because the OpenTelemetry middleware should be installed in the first stack (in the sample code we place it in the
<a href=https://github.com/yusufsyaifudin/rails-otel/blob/c85c199c3a46ddb0a245f4ccd340bf5850fa17dd/app/services/vouchers/user_voucher.rb#L7>business logic level code</a>), so it cannot be printed in the middleware. <code>username</code> value is only available after
<a href=https://github.com/yusufsyaifudin/rails-otel/blob/c85c199c3a46ddb0a245f4ccd340bf5850fa17dd/app/services/vouchers/user_voucher.rb#L11>this line.</a></p><p>So, we can change our code a bit.</p><p>From:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug <span style=color:#e6db74>&#34;calling PromotionService.list_vouchers from UserVoucher.list_vouchers </span><span style=color:#e6db74>#{</span>user_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>That produces log:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T10:43:45.525+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;calling PromotionService.list_vouchers from UserVoucher.list_vouchers c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;26136c1a589d1a1735e517f36a4c71ed&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;f32d0b8848232ea8&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;1312c7ba-d448-42a5-95d5-0bb32b837d61&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>}
</span></span></code></pre></div><p>To:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>logger<span style=color:#f92672>.</span>debug_ctx(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;calling PromotionService.list_vouchers from UserVoucher.list_vouchers&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>  {<span style=color:#e6db74>username</span>: user<span style=color:#f92672>.</span>username},
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>That produces:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;DEBUG&#34;</span>,<span style=color:#f92672>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2023-04-03T10:44:38.701+00:00&#34;</span>,<span style=color:#f92672>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;calling PromotionService.list_vouchers from UserVoucher.list_vouchers&#34;</span>,<span style=color:#f92672>&#34;trace_id&#34;</span>:<span style=color:#e6db74>&#34;6c93b69dd5e395f20c5338375a540bd5&#34;</span>,<span style=color:#f92672>&#34;span_id&#34;</span>:<span style=color:#e6db74>&#34;72a37953b7e9cd79&#34;</span>,<span style=color:#f92672>&#34;trace_flags&#34;</span>:<span style=color:#e6db74>&#34;00&#34;</span>,<span style=color:#f92672>&#34;node_id&#34;</span>:<span style=color:#e6db74>&#34;1312c7ba-d448-42a5-95d5-0bb32b837d61&#34;</span>,<span style=color:#f92672>&#34;progname&#34;</span>:<span style=color:#e6db74>&#34;rails-otel&#34;</span>,<span style=color:#f92672>&#34;attributes&#34;</span>:[{<span style=color:#f92672>&#34;username&#34;</span>:<span style=color:#e6db74>&#34;jane&#34;</span>}]}
</span></span></code></pre></div><p><strong>Changes on this section can be seen at this commit
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/81ffd38e9bbfc23da2a5441dc002dce837985d8f?diff=split">81ffd38</a>.</strong></p><h2 id=bonus-add-trace-using-opentelemetry>Bonus: Add Trace using OpenTelemetry
<a class=anchor href=#bonus-add-trace-using-opentelemetry>#</a></h2><p>When you see on Figure 8, you see that in one request there will be 25 spans. But, after adding OpenTelemetry middleware, it will be 26 spans because we adding
<a href=https://github.com/yusufsyaifudin/rails-otel/blob/5467b1bb2c3dc7eaacc58ee65701ed6d1d6b8b89/config/middleware_otel.rb#L52-L53>new span here</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>span_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;REQUEST_METHOD&#39;</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>#{</span>env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;PATH_INFO&#39;</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>span <span style=color:#f92672>=</span> <span style=color:#66d9ef>MyAppTracer</span><span style=color:#f92672>.</span>start_span(span_name, <span style=color:#e6db74>with_parent</span>: context, <span style=color:#e6db74>attributes</span>: attributes)
</span></span></code></pre></div><p>But, the interesting thing is when we look at the Figure 11, the first request with trace ID 691f94e (Figure 12) has more Span than second request (trace ID fbcc7d5, Figure 13). Also, we notice that in the third request it has 20 spans but before that, the Rails produce the DEALLOCATE span (Figure 14).</p><p><img src=/blog/post-assets/2023-02-24/jaegerui-dashboard-with-more-traces.png alt="Figure 11. Jaeger UI With More Traces"></p><div style=text-align:center;margin-bottom:30px>Figure 11. Jaeger UI With More Traces</div><p>Here&rsquo;s the timeline of the requests, and it&rsquo;s Trace ID:</p><ol><li>April 4 2023, 09:26:13.485 -> 691f94e426b88f0c96a1c38b7ecbceb9 -> Figure 12</li><li>April 4 2023, 09:26:15.277 -> fbcc7d5139bcaf6cbe9755a8b95f4503 -> Figure 13</li><li>April 4 2023, 09:31:57.623 -> 43bb5b582cb4c8e801dce2449e61aca6 -> Figure 14</li><li>April 4 2023, 09:33:07.753 -> e8453e2284e26bf1a4bbf4b5ddeb7c8e -> Figure 15</li><li>April 4 2023, 09:33:08.984 -> 2d0666880d55e6e194cc6a89d02634f4 -> Figure 16</li><li>April 4 2023, 09:33:10.040 -> d2fcb8edaa56c09fd1cf4efcddebe3b9 -> Figure 17</li></ol><details><summary>Collection of JaegerUI</summary><p><img src=/blog/post-assets/2023-02-24/jaegerui-691f94e426b88f0c96a1c38b7ecbceb9.png alt="Figure 12. Jaeger UI Trace ID 691f94e426b88f0c96a1c38b7ecbceb9"></p><div style=text-align:center;margin-bottom:30px>Figure 12. Jaeger UI Trace ID 691f94e426b88f0c96a1c38b7ecbceb9</div><p><img src=/blog/post-assets/2023-02-24/jaegerui-fbcc7d5139bcaf6cbe9755a8b95f4503.png alt="Figure 13. Jaeger UI Trace ID fbcc7d5139bcaf6cbe9755a8b95f4503"></p><div style=text-align:center;margin-bottom:30px>Figure 13. Jaeger UI Trace ID fbcc7d5139bcaf6cbe9755a8b95f4503</div><p><img src=/blog/post-assets/2023-02-24/jaegerui-43bb5b582cb4c8e801dce2449e61aca6.png alt="Figure 14. Jaeger UI Trace ID 43bb5b582cb4c8e801dce2449e61aca6"></p><div style=text-align:center;margin-bottom:30px>Figure 14. Jaeger UI Trace ID 43bb5b582cb4c8e801dce2449e61aca6</div><p><img src=/blog/post-assets/2023-02-24/jaegerui-e8453e2284e26bf1a4bbf4b5ddeb7c8e.png alt="Figure 15. Jaeger UI Trace ID e8453e2284e26bf1a4bbf4b5ddeb7c8e"></p><div style=text-align:center;margin-bottom:30px>Figure 15. Jaeger UI Trace ID e8453e2284e26bf1a4bbf4b5ddeb7c8e</div><p><img src=/blog/post-assets/2023-02-24/jaegerui-2d0666880d55e6e194cc6a89d02634f4.png alt="Figure 16. Jaeger UI Trace ID 2d0666880d55e6e194cc6a89d02634f4"></p><div style=text-align:center;margin-bottom:30px>Figure 16. Jaeger UI Trace ID 2d0666880d55e6e194cc6a89d02634f4</div><p><img src=/blog/post-assets/2023-02-24/jaegerui-d2fcb8edaa56c09fd1cf4efcddebe3b9.png alt="Figure 17. Jaeger UI Trace ID d2fcb8edaa56c09fd1cf4efcddebe3b9"></p><div style=text-align:center;margin-bottom:30px>Figure 17. Jaeger UI Trace ID d2fcb8edaa56c09fd1cf4efcddebe3b9</div></details><p>But, I don&rsquo;t want to focus on this, I assume that those behavior is part of the magic from Rails framework.</p><p>In this section, I want to show you how to add new span. For example, in the trace ID d2fcb8edaa56c09fd1cf4efcddebe3b9 (Figure 17), we only have 5 spans. Which create the waterfall like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>UserPromotionController#list_vouchers 
</span></span><span style=display:flex><span>  -&gt; GET /list-vouchers
</span></span><span style=display:flex><span>     -&gt; rails_otel_dev
</span></span><span style=display:flex><span>     -&gt; User.find_by_sql
</span></span><span style=display:flex><span>        -&gt; EXECUTE rails_otel_dev
</span></span></code></pre></div><p>But, in our code we have some function that does not show in the span such as function
<a href=https://github.com/yusufsyaifudin/rails-otel/blob/5467b1bb2c3dc7eaacc58ee65701ed6d1d6b8b89/app/services/vouchers/user_voucher.rb#L4>Vouchers::UserVoucher::vouchers</a> which then call
<a href=https://github.com/yusufsyaifudin/rails-otel/blob/5467b1bb2c3dc7eaacc58ee65701ed6d1d6b8b89/app/externals/promotions/promotion_service.rb#L4>Promotions::PromotionService::list_vouchers</a>.
To make it visible, we need to wrap our code with this block:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>MyAppTracer</span><span style=color:#f92672>.</span>in_span(<span style=color:#e6db74>&#34;your span name&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>span<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># the rest of your code that want be traced</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This is documented
<a href=https://github.com/open-telemetry/opentelemetry.io/blob/7f1501407b9643b4f517a189b3544ad08ec6ca07/content/en/docs/instrumentation/ruby/manual.md>here</a> on the
<a href=https://github.com/open-telemetry/opentelemetry.io/releases/tag/2023.04>release tag 2023.04</a>.</p><p>Now, if we access our app, the JaegerUI tracing will show as shown in Figure 18.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v http://localhost:3000/list-vouchers<span style=color:#ae81ff>\?</span>token<span style=color:#ae81ff>\=</span>eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYzhjNjk5MWMtNjg3ZS00NGNjLTg3NTUtNDc0M2VmNjZkMjY1In0.TCrEUFziQY4800jAT9ioY2mOm_b9eLdC20gtXjdTt14
</span></span><span style=display:flex><span>*   Trying 127.0.0.1:3000...
</span></span><span style=display:flex><span>* Connected to localhost <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> port <span style=color:#ae81ff>3000</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /list-vouchers?token<span style=color:#f92672>=</span>eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYzhjNjk5MWMtNjg3ZS00NGNjLTg3NTUtNDc0M2VmNjZkMjY1In0.TCrEUFziQY4800jAT9ioY2mOm_b9eLdC20gtXjdTt14 HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: localhost:3000
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.86.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>&lt; X-Frame-Options: SAMEORIGIN
</span></span><span style=display:flex><span>&lt; X-XSS-Protection: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>&lt; X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>&lt; X-Download-Options: noopen
</span></span><span style=display:flex><span>&lt; X-Permitted-Cross-Domain-Policies: none
</span></span><span style=display:flex><span>&lt; Referrer-Policy: strict-origin-when-cross-origin
</span></span><span style=display:flex><span>&lt; Content-Type: */*; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>&lt; Vary: Accept
</span></span><span style=display:flex><span>&lt; ETag: W/<span style=color:#e6db74>&#34;0a89d7478ece4a7e8d2b8acbc102aff6&#34;</span>
</span></span><span style=display:flex><span>&lt; Cache-Control: max-age<span style=color:#f92672>=</span>0, private, must-revalidate
</span></span><span style=display:flex><span>&lt; X-Request-Id: d8c74eb4-4b80-4824-a40d-f82881b3bba2
</span></span><span style=display:flex><span>&lt; X-Runtime: 0.411438
</span></span><span style=display:flex><span>&lt; Server-Timing: start_processing.action_controller;dur<span style=color:#f92672>=</span>0.64, sql.active_record;dur<span style=color:#f92672>=</span>3.71, instantiation.active_record;dur<span style=color:#f92672>=</span>0.44, process_action.action_controller;dur<span style=color:#f92672>=</span>377.52
</span></span><span style=display:flex><span>&lt; traceparent: 00-a8f1b4a938dd800bef349037d25b9524-f63a980145e5e597-01
</span></span><span style=display:flex><span>&lt; Transfer-Encoding: chunked
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span>* Connection <span style=color:#75715e>#0 to host localhost left intact</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;user&#34;</span>:<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;c8c6991c-687e-44cc-8755-4743ef66d265&#34;</span>,<span style=color:#e6db74>&#34;username&#34;</span>:<span style=color:#e6db74>&#34;jane&#34;</span>,<span style=color:#e6db74>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Jane Kepiye Karepe To&#34;</span>,<span style=color:#e6db74>&#34;created_at&#34;</span>:<span style=color:#e6db74>&#34;2023-03-02T09:15:51.346Z&#34;</span>,<span style=color:#e6db74>&#34;updated_at&#34;</span>:<span style=color:#e6db74>&#34;2023-03-02T09:15:51.346Z&#34;</span><span style=color:#f92672>}</span>,<span style=color:#e6db74>&#34;vouchers&#34;</span>:<span style=color:#f92672>[[{</span><span style=color:#e6db74>&#34;voucher_code&#34;</span>:<span style=color:#e6db74>&#34;REGISTER_ANNIVERSARY&#34;</span>,<span style=color:#e6db74>&#34;description&#34;</span>:<span style=color:#e6db74>&#34;will get 5% discount if user is a loyal users (already joined minimum 1 year)&#34;</span>,<span style=color:#e6db74>&#34;terms_and_conditions&#34;</span>:<span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;discount&#34;</span>:5,<span style=color:#e6db74>&#34;min_registered_year&#34;</span>:1,<span style=color:#e6db74>&#34;registered_date_is_same&#34;</span>:true,<span style=color:#e6db74>&#34;registered_month_is_same&#34;</span>:true,<span style=color:#e6db74>&#34;name_prefix&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>}]}]</span>,<span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;voucher_code&#34;</span>:<span style=color:#e6db74>&#34;I_AM_JAN&#34;</span>,<span style=color:#e6db74>&#34;description&#34;</span>:<span style=color:#e6db74>&#34;will get 1% discount if user have name prefix &#39;jan&#39; because our app is launched at January!&#34;</span>,<span style=color:#e6db74>&#34;terms_and_conditions&#34;</span>:<span style=color:#f92672>[{</span><span style=color:#e6db74>&#34;discount&#34;</span>:1,<span style=color:#e6db74>&#34;min_registered_year&#34;</span>:0,<span style=color:#e6db74>&#34;registered_date_is_same&#34;</span>:false,<span style=color:#e6db74>&#34;registered_month_is_same&#34;</span>:false,<span style=color:#e6db74>&#34;name_prefix&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>}]}]]}</span>%    
</span></span></code></pre></div><p><img src=/blog/post-assets/2023-02-24/jaegerui-a8f1b4a938dd800bef349037d25b9524.png alt="Figure 18. Jaeger UI Trace ID a8f1b4a938dd800bef349037d25b9524 After Adding More Span"></p><div style=text-align:center;margin-bottom:30px>Figure 18. Jaeger UI Trace ID a8f1b4a938dd800bef349037d25b9524 After Adding More Span</div><p><strong>Changes on this section can be seen at this commit
<a href="https://github.com/yusufsyaifudin/rails-otel/commit/89bd3f99ca422f17c58b47e3537385ae6fa23ca3?diff=split">89bd3f9</a>.</strong></p><h1 id=conclusion>Conclusion
<a class=anchor href=#conclusion>#</a></h1><p>After installing OpenTelemetry and duck-typing some classes, now we have all our log formatted to JSON.
Now we can pipe this log into Elasticsearch or any logging tools that support query. By using that, we can easily to group the log based on <code>trace_id</code>.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/yusufsyaifudin/blog/commit/1af3d1d4da5c17cf74a1d39d43ac16dcef5fb2f0 title='Last modified by Yusuf Syaifudin | December 27, 2023' target=_blank rel=noopener><img src=/blog/svg/calendar.svg class=book-icon alt=Calendar>
<span>December 27, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/yusufsyaifudin/blog/edit/main/content/posts/2023-02-24-rails-otel-part2.md target=_blank rel=noopener><img src=/blog/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#give-traffics-to-rails-application>Give Traffics to Rails Application</a><ul><li><a href=#preparing-the-data>Preparing the data</a></li><li><a href=#generate-traffic-using-k6-load-testing>Generate Traffic Using <code>k6</code> Load Testing</a></li></ul></li><li><a href=#breaking-down-the-problem>Breaking down the problem</a><ul><li><a href=#complexity-and-volume>Complexity and Volume</a></li><li><a href=#lack-of-structure>Lack of structure</a></li><li><a href=#lack-of-context>Lack of context</a></li><li><a href=#lack-of-tooling>Lack of tooling</a></li></ul></li><li><a href=#refactoring-log-output-to-structured-log>Refactoring Log Output To Structured Log</a><ul><li><a href=#change-the-booting-output>Change the Booting Output</a></li><li><a href=#add-opentelemetry-sdk>Add OpenTelemetry SDK</a></li><li><a href=#duck-typing-the-rubylogger>Duck-typing the Ruby::Logger</a></li><li><a href=#duck-typing-the-ruby-activerecord-logger>Duck-typing the Ruby ActiveRecord Logger</a></li><li><a href=#creating-opentelemetry-middleware>Creating OpenTelemetry Middleware</a></li><li><a href=#using-custom-logger-function>Using Custom Logger Function</a></li><li><a href=#bonus-add-trace-using-opentelemetry>Bonus: Add Trace using OpenTelemetry</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></aside></main></body></html>